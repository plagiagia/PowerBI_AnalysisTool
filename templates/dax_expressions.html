{% extends "base.html" %}
{% block title %}DAX Explorer - Power BI Explorer{% endblock %}

{% block header_icon %}<i class="fas fa-code"></i>{% endblock %}
{% block header_title %}DAX Code Analyzer{% endblock %}
{% block header_subtitle %}Browse and analyze DAX formulas with advanced features{% endblock %}

{% block header_stats %}
<div class="quick-stat">
  <span class="stat-number">{{ dax_expressions|length if dax_expressions else 0 }}</span>
  <span class="stat-label">DAX Expressions</span>
</div>
<div class="quick-stat">
  <span class="stat-number">{{ (dax_expressions|map(attribute='1')|map('length')|sum / 1000)|round(1) if dax_expressions
    else 0 }}K</span>
  <span class="stat-label">Total Characters</span>
</div>
{% endblock %}

{% block head %}
<!-- Include Prism.js CSS for syntax highlighting -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" />
<!-- Include FontAwesome for icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
{% endblock %}

{% block breadcrumbs %}
<li>
  <a href="/dax-expressions"><i class="fas fa-code"></i><span class="breadcrumb-text">DAX Explorer</span></a>
</li>
{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="page-header">
  <h1 class="page-title"><i class="fas fa-code"></i> DAX Explorer</h1>
  <p class="page-description">
    Browse, analyze, and optimize your DAX formulas with advanced search and similarity detection.
  </p>
</div>

<!-- Enhanced Search and Filter Bar -->
<div class="search-filter-container">
  <div class="search-section">
    <div class="search-input-wrapper large">
      <i class="fas fa-search"></i>
      <input type="search" id="searchDax" placeholder="Search measure names or DAX code..."
        aria-label="Search DAX expressions" />
      <button id="clearSearch" class="clear-search" style="display: none" aria-label="Clear search">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="search-options">
      <label class="search-option">
        <input type="checkbox" id="searchInCode" checked>
        <span>Search in code</span>
      </label>
      <label class="search-option">
        <input type="checkbox" id="caseSensitive">
        <span>Case sensitive</span>
      </label>
    </div>
  </div>

  <div class="filter-section">


    <div class="filter-group">
      <label class="filter-label">Functions</label>
      <select id="functionFilter" class="filter-select">
        <option value="all">All Functions</option>
        <option value="CALCULATE">CALCULATE</option>
        <option value="SUMX">SUMX/AVERAGEX</option>
        <option value="FILTER">FILTER</option>
        <option value="IF">IF/SWITCH</option>
        <option value="other">Other</option>
      </select>
    </div>
  </div>
</div>

<!-- View Options and Actions -->
<div class="table-toolbar enhanced">
  <div class="table-info">
    <div class="results-count">
      <span class="count-number" id="visibleCount">{{ dax_expressions|length }}</span>
      <span class="count-label">of</span>
      <span class="count-total" id="totalCount">{{ dax_expressions|length }}</span>
      <span class="count-label">measures shown</span>
    </div>
  </div>

  <div class="table-actions">


    <button id="analyzeSimilarity" class="action-button secondary">
      <i class="fas fa-fingerprint"></i> Analyze Similarity
    </button>

    <button id="expandAll" class="action-button outline">
      <i class="fas fa-expand-alt"></i> Expand All
    </button>

    <button id="collapseAll" class="action-button outline">
      <i class="fas fa-compress-alt"></i> Collapse All
    </button>

    <button id="exportDax" class="action-button primary">
      <i class="fas fa-download"></i> Export
    </button>
  </div>
</div>

<!-- DAX Expressions Container -->
<div id="daxContainer" class="dax-container">
  <!-- DAX List -->
  <div id="daxList" class="dax-list">
    {% for label, expression in dax_expressions %}
    <div class="dax-card" data-measure="{{ label }}" data-length="{{ expression|length }}">
      <div class="dax-card-header">
        <div class="measure-info">
          <div class="measure-icon">
            <i class="fas fa-calculator"></i>
          </div>
          <div class="measure-details">
            <h3 class="measure-name">{{ label }}</h3>
            <div class="measure-metadata">

            </div>
          </div>
        </div>

        <div class="measure-actions">
          <button class="icon-button copy-name" title="Copy measure name" data-copy="{{ label }}">
            <i class="fas fa-tag"></i>
          </button>
          <button class="icon-button copy-code" title="Copy DAX code" data-measure="{{ label }}">
            <i class="fas fa-copy"></i>
          </button>
          <button class="icon-button toggle-expand" title="Expand/collapse">
            <i class="fas fa-chevron-down"></i>
          </button>
        </div>
      </div>

      <div class="dax-card-content">
        <div class="code-container">
          <div class="code-header">
            <span class="code-label">DAX Expression</span>
            <div class="code-actions">
              <button class="code-action format-code" title="Format code">
                <i class="fas fa-indent"></i>
              </button>
              <button class="code-action analyze-dependencies" title="Analyze dependencies">
                <i class="fas fa-project-diagram"></i>
              </button>
            </div>
          </div>
          <pre class="line-numbers"><code class="language-dax">{{ expression }}</code></pre>
        </div>

        <div class="measure-analysis" style="display: none;">
          <div class="analysis-section">
            <h4><i class="fas fa-puzzle-piece"></i> Functions Used</h4>
            <div class="function-tags" data-measure="{{ label }}">
              <!-- Will be populated by JavaScript -->
            </div>
          </div>

          <div class="analysis-section">
            <h4><i class="fas fa-link"></i> Referenced Measures</h4>
            <div class="reference-list" data-measure="{{ label }}">
              <!-- Will be populated by JavaScript -->
            </div>
          </div>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>

  <!-- Empty State -->
  <div id="emptyState" class="empty-state" style="display: none">
    <div class="empty-state-icon">
      <i class="fas fa-search"></i>
    </div>
    <h3 class="empty-state-title">No DAX expressions found</h3>
    <p class="empty-state-message">Try adjusting your search terms or filters.</p>
    <button id="clearFilters" class="action-button primary">
      <i class="fas fa-undo"></i> Clear All Filters
    </button>
  </div>
</div>

<!-- Enhanced Similarity Analysis Modal -->
<div id="similarityModal" class="modal-overlay" style="display: none;">
  <div class="modal-content large">
    <div class="modal-header">
      <h2 class="modal-title">
        <i class="fas fa-fingerprint"></i>
        Measure Similarity Analysis
      </h2>
      <button id="closeSimilarity" class="modal-close">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <div class="modal-body">
      <div class="similarity-controls">
        <div class="control-group">
          <label for="similarityThreshold">Similarity Threshold</label>
          <div class="threshold-control">
            <input type="range" id="similarityThreshold" min="50" max="95" step="5" value="70">
            <span class="threshold-value" id="thresholdValue">70%</span>
          </div>
        </div>

        <div class="similarity-stats">
          <div class="stat-item">
            <span class="stat-value" id="totalPairs">0</span>
            <span class="stat-label">Total Pairs</span>
          </div>
          <div class="stat-item">
            <span class="stat-value" id="similarPairsCount">0</span>
            <span class="stat-label">Similar Pairs</span>
          </div>
          <div class="stat-item">
            <span class="stat-value" id="highestSimilarityValue">0%</span>
            <span class="stat-label">Highest Match</span>
          </div>
        </div>
      </div>

      <div class="similarity-results">
        <div class="results-header">
          <h3>Similar Measure Pairs</h3>
          <button id="exportSimilarity" class="action-button secondary">
            <i class="fas fa-download"></i> Export Results
          </button>
        </div>

        <div id="similarityGrid" class="similarity-grid">
          <!-- Will be populated by JavaScript -->
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Loading Overlay -->
<div id="loadingOverlay" class="loading-overlay" style="display: none;">
  <div class="loading-content">
    <div class="loading-spinner"></div>
    <div class="loading-text">Analyzing measures...</div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<!-- Include Prism.js for syntax highlighting -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-dax.min.js"></script>
<script
  src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/line-numbers/prism-line-numbers.min.js"></script>

<script>
  class DAXExplorer {
    constructor() {
      this.daxExpressions = this.collectDAXExpressions();
      this.filteredExpressions = [...this.daxExpressions];
      this.similarityResults = [];


      this.init();
    }

    init() {
      this.setupEventListeners();
      this.applyInitialHighlighting();
    }

    collectDAXExpressions() {
      const expressions = [];
      document.querySelectorAll('.dax-card').forEach(card => {
        const name = card.getAttribute('data-measure');
        const codeElement = card.querySelector('code');
        if (name && codeElement) {
          expressions.push({
            name: name,
            code: codeElement.textContent,
            element: card,
            length: parseInt(card.getAttribute('data-length') || '0')
          });
        }
      });
      return expressions;
    }

    setupEventListeners() {
      // Search functionality
      const searchInput = document.getElementById('searchDax');
      const clearSearch = document.getElementById('clearSearch');
      const searchInCode = document.getElementById('searchInCode');
      const caseSensitive = document.getElementById('caseSensitive');

      searchInput?.addEventListener('input', this.debounce(() => {
        clearSearch.style.display = searchInput.value ? 'block' : 'none';
        this.performSearch();
      }, 300));

      clearSearch?.addEventListener('click', () => {
        searchInput.value = '';
        clearSearch.style.display = 'none';
        this.performSearch();
      });

      searchInCode?.addEventListener('change', () => this.performSearch());
      caseSensitive?.addEventListener('change', () => this.performSearch());

      // Filters
      document.getElementById('functionFilter')?.addEventListener('change', () => this.applyFilters());

      // Bulk actions
      document.getElementById('expandAll')?.addEventListener('click', () => this.toggleAllCards(true));
      document.getElementById('collapseAll')?.addEventListener('click', () => this.toggleAllCards(false));

      // Export
      document.getElementById('exportDax')?.addEventListener('click', () => this.exportDAX());

      // Similarity analysis
      document.getElementById('analyzeSimilarity')?.addEventListener('click', () => this.showSimilarityAnalysis());
      document.getElementById('closeSimilarity')?.addEventListener('click', () => this.hideSimilarityAnalysis());
      document.getElementById('similarityThreshold')?.addEventListener('input', (e) => this.updateSimilarityThreshold(e));
      document.getElementById('exportSimilarity')?.addEventListener('click', () => this.exportSimilarityResults());

      // Card interactions
      this.setupCardInteractions();

      // Clear filters
      document.getElementById('clearFilters')?.addEventListener('click', () => this.clearAllFilters());
    }

    setupCardInteractions() {
      document.querySelectorAll('.dax-card').forEach(card => {
        // Expand/collapse
        const toggleBtn = card.querySelector('.toggle-expand');
        toggleBtn?.addEventListener('click', () => this.toggleCard(card));

        // Copy buttons
        const copyNameBtn = card.querySelector('.copy-name');
        const copyCodeBtn = card.querySelector('.copy-code');

        copyNameBtn?.addEventListener('click', (e) => {
          const name = e.currentTarget.getAttribute('data-copy');
          this.copyToClipboard(name, 'Measure name');
        });

        copyCodeBtn?.addEventListener('click', (e) => {
          const measureName = e.currentTarget.getAttribute('data-measure');
          const measure = this.daxExpressions.find(m => m.name === measureName);
          if (measure) {
            this.copyToClipboard(measure.code, 'DAX code');
          }
        });

        // Format code button
        const formatBtn = card.querySelector('.format-code');
        formatBtn?.addEventListener('click', () => this.formatDAXCode(card));

        // Analyze dependencies
        const analyzeBtn = card.querySelector('.analyze-dependencies');
        analyzeBtn?.addEventListener('click', () => this.analyzeMeasureDependencies(card));
      });
    }






    extractFunctions(code) {
      const functionPattern = /\b([A-Z][A-Z0-9]*(?:\.[A-Z][A-Z0-9]*)?)\s*\(/g;
      const functions = new Set();
      let match;

      while ((match = functionPattern.exec(code)) !== null) {
        functions.add(match[1]);
      }

      return Array.from(functions).slice(0, 5); // Limit to 5 most relevant
    }

    findReferencedMeasures(code) {
      const references = new Set();

      // Look for [MeasureName] pattern
      const measurePattern = /\[([^\[\]]+)\]/g;
      let match;

      while ((match = measurePattern.exec(code)) !== null) {
        const potentialMeasure = match[1];
        // Check if this is actually a measure (exists in our list)
        if (this.daxExpressions.some(expr => expr.name === potentialMeasure)) {
          references.add(potentialMeasure);
        }
      }

      return Array.from(references);
    }

    performSearch() {
      const searchTerm = document.getElementById('searchDax').value.toLowerCase();
      const searchInCode = document.getElementById('searchInCode').checked;
      const caseSensitive = document.getElementById('caseSensitive').checked;

      this.clearHighlights();

      if (!searchTerm) {
        this.applyFilters();
        return;
      }

      const searchTermActual = caseSensitive ? document.getElementById('searchDax').value : searchTerm;

      this.filteredExpressions = this.daxExpressions.filter(expr => {
        const nameMatch = caseSensitive ?
          expr.name.includes(searchTermActual) :
          expr.name.toLowerCase().includes(searchTerm);

        const codeMatch = searchInCode && (caseSensitive ?
          expr.code.includes(searchTermActual) :
          expr.code.toLowerCase().includes(searchTerm));

        const matches = nameMatch || codeMatch;

        if (matches && searchTerm) {
          this.highlightSearchTerm(expr.element, searchTermActual, nameMatch, codeMatch);
        }

        return matches;
      });

      this.updateDisplay();
    }

    highlightSearchTerm(card, searchTerm, inName, inCode) {
      if (inName) {
        const nameElement = card.querySelector('.measure-name');
        if (nameElement) {
          const regex = new RegExp(`(${this.escapeRegExp(searchTerm)})`, 'gi');
          nameElement.innerHTML = nameElement.textContent.replace(regex, '<mark>$1</mark>');
        }
      }

      if (inCode && card.classList.contains('expanded')) {
        const codeElement = card.querySelector('code');
        if (codeElement) {
          const regex = new RegExp(`(${this.escapeRegExp(searchTerm)})`, 'gi');
          const originalCode = codeElement.textContent;
          codeElement.innerHTML = originalCode.replace(regex, '<mark>$1</mark>');
          // Re-apply syntax highlighting
          Prism.highlightElement(codeElement);
        }
      }
    }

    clearHighlights() {
      document.querySelectorAll('.measure-name mark').forEach(mark => {
        const parent = mark.parentNode;
        parent.replaceChild(document.createTextNode(mark.textContent), mark);
        parent.normalize();
      });

      document.querySelectorAll('code mark').forEach(mark => {
        const parent = mark.parentNode;
        parent.replaceChild(document.createTextNode(mark.textContent), mark);
        parent.normalize();
      });
    }

    applyFilters() {
      const searchTerm = document.getElementById('searchDax').value.toLowerCase();
      const complexity = document.getElementById('complexityFilter').value;
      const functionFilter = document.getElementById('functionFilter').value;

      this.filteredExpressions = this.daxExpressions.filter(expr => {
        let matches = true;

        // Search filter (if any)
        if (searchTerm) {
          const searchInCode = document.getElementById('searchInCode').checked;
          matches = expr.name.toLowerCase().includes(searchTerm) ||
            (searchInCode && expr.code.toLowerCase().includes(searchTerm));
        }



        // Function filter
        if (functionFilter !== 'all' && matches) {
          if (functionFilter === 'other') {
            matches = !expr.code.match(/\b(CALCULATE|SUMX|AVERAGEX|FILTER|IF|SWITCH)\b/i);
          } else if (functionFilter === 'SUMX') {
            matches = expr.code.match(/\b(SUMX|AVERAGEX)\b/i);
          } else {
            matches = expr.code.match(new RegExp(`\\b${functionFilter}\\b`, 'i'));
          }
        }

        return matches;
      });

      this.updateDisplay();
    }

    updateDisplay() {
      // Hide all cards first
      this.daxExpressions.forEach(expr => {
        expr.element.style.display = 'none';
      });

      // Show filtered cards
      this.filteredExpressions.forEach(expr => {
        expr.element.style.display = '';
      });

      // Update counts
      document.getElementById('visibleCount').textContent = this.filteredExpressions.length;
      document.getElementById('totalCount').textContent = this.daxExpressions.length;

      // Show/hide empty state
      const emptyState = document.getElementById('emptyState');
      const daxList = document.getElementById('daxList');

      if (this.filteredExpressions.length === 0) {
        emptyState.style.display = 'flex';
        daxList.style.display = 'none';
      } else {
        emptyState.style.display = 'none';
        daxList.style.display = '';
      }
    }

    toggleCard(card) {
      const isExpanded = card.classList.contains('expanded');
      card.classList.toggle('expanded');

      const toggleBtn = card.querySelector('.toggle-expand i');
      if (toggleBtn) {
        toggleBtn.className = isExpanded ? 'fas fa-chevron-down' : 'fas fa-chevron-up';
      }

      // Show/hide analysis section
      const analysisSection = card.querySelector('.measure-analysis');
      if (analysisSection) {
        analysisSection.style.display = isExpanded ? 'none' : 'block';
      }

      // Re-highlight if needed
      const searchTerm = document.getElementById('searchDax').value;
      if (searchTerm && !isExpanded) {
        const measure = this.daxExpressions.find(expr => expr.element === card);
        if (measure && measure.code.toLowerCase().includes(searchTerm.toLowerCase())) {
          this.highlightSearchTerm(card, searchTerm, false, true);
        }
      }
    }

    toggleAllCards(expand) {
      this.filteredExpressions.forEach(expr => {
        const card = expr.element;
        card.classList.toggle('expanded', expand);

        const toggleBtn = card.querySelector('.toggle-expand i');
        if (toggleBtn) {
          toggleBtn.className = expand ? 'fas fa-chevron-up' : 'fas fa-chevron-down';
        }

        const analysisSection = card.querySelector('.measure-analysis');
        if (analysisSection) {
          analysisSection.style.display = expand ? 'block' : 'none';
        }
      });
    }

    formatDAXCode(card) {
      const codeElement = card.querySelector('code');
      if (!codeElement) return;

      let code = codeElement.textContent;

      // Basic DAX formatting
      code = this.formatDAX(code);

      codeElement.textContent = code;
      Prism.highlightElement(codeElement);

      this.showNotification('DAX code formatted', 'success');
    }

    formatDAX(code) {
      // Basic DAX formatter
      let formatted = code;

      // Add newlines after commas in function calls
      formatted = formatted.replace(/,(?![^\(]*\))/g, ',\n    ');

      // Add newlines before RETURN
      formatted = formatted.replace(/(\s*)RETURN/gi, '\n$1RETURN');

      // Add newlines after VAR declarations
      formatted = formatted.replace(/VAR\s+(\w+)\s*=/gi, 'VAR $1 =');
      formatted = formatted.replace(/(VAR\s+\w+\s*=.*?)(?=VAR|RETURN|$)/gi, '$1\n');

      // Format CALCULATE
      formatted = formatted.replace(/CALCULATE\s*\(/gi, 'CALCULATE(\n    ');

      // Clean up extra spaces
      formatted = formatted.replace(/\n\s*\n/g, '\n');
      formatted = formatted.trim();

      return formatted;
    }

    analyzeMeasureDependencies(card) {
      const measureName = card.getAttribute('data-measure');
      const measure = this.daxExpressions.find(m => m.name === measureName);

      if (!measure) return;

      // This would integrate with the lineage view data
      // For now, just show what we can detect from the code
      const references = this.findReferencedMeasures(measure.code);
      const referencedBy = this.findMeasuresReferencingThis(measureName);

      let message = `<strong>${measureName}</strong><br><br>`;

      if (references.length > 0) {
        message += `<strong>References:</strong><br>`;
        message += references.map(ref => `• [${ref}]`).join('<br>');
        message += '<br><br>';
      }

      if (referencedBy.length > 0) {
        message += `<strong>Referenced by:</strong><br>`;
        message += referencedBy.map(ref => `• [${ref}]`).join('<br>');
      }

      if (references.length === 0 && referencedBy.length === 0) {
        message += 'No dependencies found.';
      }

      this.showNotification(message, 'info', 5000);
    }

    findMeasuresReferencingThis(measureName) {
      const referencedBy = [];

      this.daxExpressions.forEach(expr => {
        if (expr.name !== measureName) {
          const pattern = new RegExp(`\\[${this.escapeRegExp(measureName)}\\]`, 'g');
          if (pattern.test(expr.code)) {
            referencedBy.push(expr.name);
          }
        }
      });

      return referencedBy;
    }

    showSimilarityAnalysis() {
      const modal = document.getElementById('similarityModal');
      const loadingOverlay = document.getElementById('loadingOverlay');

      modal.style.display = 'flex';
      loadingOverlay.style.display = 'flex';

      // Perform similarity analysis
      setTimeout(() => {
        this.analyzeSimilarity();
        loadingOverlay.style.display = 'none';
      }, 100);
    }

    hideSimilarityAnalysis() {
      document.getElementById('similarityModal').style.display = 'none';
    }

    analyzeSimilarity() {
      this.similarityResults = [];
      const threshold = parseInt(document.getElementById('similarityThreshold').value) / 100;

      // Compare all pairs
      for (let i = 0; i < this.daxExpressions.length; i++) {
        for (let j = i + 1; j < this.daxExpressions.length; j++) {
          const similarity = this.calculateSimilarity(
            this.daxExpressions[i].code,
            this.daxExpressions[j].code
          );

          if (similarity >= 0.5) { // Store all results above 50%
            this.similarityResults.push({
              measure1: this.daxExpressions[i].name,
              measure2: this.daxExpressions[j].name,
              code1: this.daxExpressions[i].code,
              code2: this.daxExpressions[j].code,
              similarity: similarity
            });
          }
        }
      }

      // Sort by similarity
      this.similarityResults.sort((a, b) => b.similarity - a.similarity);

      // Update stats
      const totalPairs = (this.daxExpressions.length * (this.daxExpressions.length - 1)) / 2;
      document.getElementById('totalPairs').textContent = totalPairs;

      // Update similarity threshold
      this.updateSimilarityDisplay(threshold);
    }

    calculateSimilarity(code1, code2) {
      // Normalize codes
      const normalize = (code) => {
        return code
          .replace(/\/\/.*$/gm, '') // Remove comments
          .replace(/\s+/g, ' ') // Normalize whitespace
          .toLowerCase()
          .trim();
      };

      const n1 = normalize(code1);
      const n2 = normalize(code2);

      // Quick length check
      const lengthRatio = Math.min(n1.length, n2.length) / Math.max(n1.length, n2.length);
      if (lengthRatio < 0.5) return lengthRatio;

      // Token-based similarity
      const tokens1 = this.tokenizeDAX(n1);
      const tokens2 = this.tokenizeDAX(n2);

      // Jaccard similarity
      const set1 = new Set(tokens1);
      const set2 = new Set(tokens2);
      const intersection = new Set([...set1].filter(x => set2.has(x)));
      const union = new Set([...set1, ...set2]);

      const jaccardSim = intersection.size / union.size;

      // Levenshtein distance for structure similarity
      const maxLen = Math.max(n1.length, n2.length);
      const levenDist = this.levenshteinDistance(n1, n2);
      const levenSim = 1 - (levenDist / maxLen);

      // Combined similarity
      return (jaccardSim * 0.6) + (levenSim * 0.4);
    }

    tokenizeDAX(code) {
      // Extract meaningful tokens from DAX
      return code.match(/\b\w+\b/g) || [];
    }

    levenshteinDistance(str1, str2) {
      const matrix = [];

      for (let i = 0; i <= str2.length; i++) {
        matrix[i] = [i];
      }

      for (let j = 0; j <= str1.length; j++) {
        matrix[0][j] = j;
      }

      for (let i = 1; i <= str2.length; i++) {
        for (let j = 1; j <= str1.length; j++) {
          if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
            matrix[i][j] = matrix[i - 1][j - 1];
          } else {
            matrix[i][j] = Math.min(
              matrix[i - 1][j - 1] + 1,
              matrix[i][j - 1] + 1,
              matrix[i - 1][j] + 1
            );
          }
        }
      }

      return matrix[str2.length][str1.length];
    }

    updateSimilarityThreshold(event) {
      const threshold = parseInt(event.target.value) / 100;
      document.getElementById('thresholdValue').textContent = `${event.target.value}%`;
      this.updateSimilarityDisplay(threshold);
    }

    updateSimilarityDisplay(threshold) {
      const filteredResults = this.similarityResults.filter(r => r.similarity >= threshold);

      // Update counts
      document.getElementById('similarPairsCount').textContent = filteredResults.length;

      if (this.similarityResults.length > 0) {
        const highest = Math.round(this.similarityResults[0].similarity * 100);
        document.getElementById('highestSimilarityValue').textContent = `${highest}%`;
      }

      // Update grid
      const grid = document.getElementById('similarityGrid');

      if (filteredResults.length === 0) {
        grid.innerHTML = `
        <div class="no-similar-measures">
          No measures found with similarity above ${Math.round(threshold * 100)}%
        </div>
      `;
        return;
      }

      grid.innerHTML = filteredResults.map((result, index) => `
      <div class="similarity-card" data-index="${index}">
        <div class="similarity-header">
          <div class="similarity-measures">
            <span class="measure-1">${result.measure1}</span>
            <i class="fas fa-exchange-alt"></i>
            <span class="measure-2">${result.measure2}</span>
          </div>
          <div class="similarity-score ${this.getSimilarityClass(result.similarity)}">
            ${Math.round(result.similarity * 100)}%
          </div>
        </div>
        <div class="similarity-actions">
          <button class="action-button outline small" onclick="daxExplorer.compareMeasures(${index})">
            <i class="fas fa-columns"></i> Compare
          </button>
          <button class="action-button outline small" onclick="daxExplorer.highlightMeasures('${result.measure1}', '${result.measure2}')">
            <i class="fas fa-highlighter"></i> Highlight
          </button>
        </div>
      </div>
    `).join('');
    }

    getSimilarityClass(similarity) {
      if (similarity >= 0.9) return 'very-high';
      if (similarity >= 0.8) return 'high';
      if (similarity >= 0.7) return 'medium';
      return 'low';
    }

    compareMeasures(index) {
      const result = this.similarityResults[index];

      // Create comparison view
      const comparisonHTML = `
      <div class="comparison-modal">
        <h3>Measure Comparison</h3>
        <div class="comparison-grid">
          <div class="comparison-pane">
            <h4>${result.measure1}</h4>
            <pre><code class="language-dax">${result.code1}</code></pre>
          </div>
          <div class="comparison-pane">
            <h4>${result.measure2}</h4>
            <pre><code class="language-dax">${result.code2}</code></pre>
          </div>
        </div>
        <div class="similarity-details">
          <strong>Similarity:</strong> ${Math.round(result.similarity * 100)}%
        </div>
      </div>
    `;

      this.showNotification(comparisonHTML, 'info', 10000);
    }

    highlightMeasures(measure1, measure2) {
      // Close similarity modal
      this.hideSimilarityAnalysis();

      // Clear any filters
      this.clearAllFilters();

      // Highlight the two measures
      this.daxExpressions.forEach(expr => {
        if (expr.name === measure1 || expr.name === measure2) {
          expr.element.classList.add('highlighted');
          expr.element.scrollIntoView({ behavior: 'smooth', block: 'center' });
        } else {
          expr.element.classList.add('dimmed');
        }
      });

      // Clear highlights after 5 seconds
      setTimeout(() => {
        document.querySelectorAll('.dax-card').forEach(card => {
          card.classList.remove('highlighted', 'dimmed');
        });
      }, 5000);
    }

    exportSimilarityResults() {
      const threshold = parseInt(document.getElementById('similarityThreshold').value) / 100;
      const results = this.similarityResults.filter(r => r.similarity >= threshold);

      const csv = [
        ['Measure 1', 'Measure 2', 'Similarity %'],
        ...results.map(r => [
          r.measure1,
          r.measure2,
          Math.round(r.similarity * 100)
        ])
      ].map(row => row.join(',')).join('\n');

      this.downloadFile(csv, 'dax_similarity_analysis.csv', 'text/csv');
    }

    exportDAX() {
      const data = this.filteredExpressions.map(expr => ({
        'Measure Name': expr.name,
        'DAX Expression': expr.code
      }));

      const csv = this.arrayToCSV(data);
      this.downloadFile(csv, 'dax_expressions.csv', 'text/csv');

      this.showNotification('DAX expressions exported successfully', 'success');
    }

    clearAllFilters() {
      document.getElementById('searchDax').value = '';
      document.getElementById('clearSearch').style.display = 'none';
      document.getElementById('functionFilter').value = 'all';

      this.clearHighlights();
      this.applyFilters();
    }

    copyToClipboard(text, label) {
      navigator.clipboard.writeText(text).then(() => {
        this.showNotification(`${label} copied to clipboard`, 'success');
      }).catch(() => {
        // Fallback
        const textarea = document.createElement('textarea');
        textarea.value = text;
        textarea.style.position = 'fixed';
        textarea.style.opacity = '0';
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);
        this.showNotification(`${label} copied to clipboard`, 'success');
      });
    }

    showNotification(message, type = 'info', duration = 3000) {
      // Use the global notification system if available
      if (window.PowerBIExplorer && window.PowerBIExplorer.showNotification) {
        window.PowerBIExplorer.showNotification(message, type, duration);
      } else {
        // Fallback
        console.log(`${type}: ${message}`);
      }
    }

    downloadFile(content, filename, mimeType) {
      const blob = new Blob([content], { type: mimeType });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    }

    arrayToCSV(data) {
      if (data.length === 0) return '';

      const headers = Object.keys(data[0]);
      const rows = data.map(row =>
        headers.map(header => {
          const value = row[header] || '';
          return value.toString().includes(',') || value.toString().includes('"')
            ? `"${value.toString().replace(/"/g, '""')}"`
            : value;
        }).join(',')
      );

      return [headers.join(','), ...rows].join('\n');
    }

    escapeRegExp(string) {
      return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    applyInitialHighlighting() {
      // Apply syntax highlighting to all code blocks
      Prism.highlightAll();
    }
  }

  // Initialize when DOM is ready
  document.addEventListener('DOMContentLoaded', () => {
    window.daxExplorer = new DAXExplorer();
  });
</script>

<style>
  /* Enhanced DAX Explorer Styles */

  /* Search and Filter Container */
  .search-filter-container {
    background: var(--glass-bg);
    backdrop-filter: blur(10px);
    border: 1px solid var(--glass-border);
    border-radius: var(--radius-lg);
    padding: var(--space-xl);
    margin-bottom: var(--space-xl);
    display: flex;
    gap: var(--space-xl);
    flex-wrap: wrap;
  }

  .search-section {
    flex: 2;
    min-width: 300px;
  }

  .search-input-wrapper.large {
    position: relative;
  }

  .search-input-wrapper.large input {
    padding: var(--space-md) var(--space-md) var(--space-md) calc(var(--space-md) * 3);
    font-size: 1rem;
    height: 48px;
  }

  .search-input-wrapper.large i {
    font-size: 1.125rem;
  }

  .search-options {
    display: flex;
    gap: var(--space-lg);
    margin-top: var(--space-sm);
  }

  .search-option {
    display: flex;
    align-items: center;
    gap: var(--space-xs);
    font-size: 0.875rem;
    color: var(--text-secondary);
    cursor: pointer;
  }

  .search-option input[type="checkbox"] {
    accent-color: var(--color-primary);
  }

  .filter-section {
    flex: 1;
    min-width: 250px;
    display: flex;
    gap: var(--space-md);
  }

  .filter-group {
    flex: 1;
  }

  .filter-label {
    display: block;
    font-size: 0.875rem;
    color: var(--text-secondary);
    margin-bottom: var(--space-xs);
    font-weight: 500;
  }

  /* Enhanced Table Toolbar */
  .table-toolbar.enhanced {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-lg);
    padding: var(--space-md) 0;
    border-bottom: 1px solid var(--glass-border);
  }

  .results-count {
    font-size: 1rem;
    color: var(--text-secondary);
  }

  .count-number {
    font-weight: 700;
    color: var(--color-primary);
    font-size: 1.125rem;
  }

  .count-total {
    font-weight: 600;
    color: var(--text-primary);
  }



  /* DAX Cards */
  .dax-container {
    margin-bottom: var(--space-2xl);
  }

  .dax-list {
    display: flex;
    flex-direction: column;
    gap: var(--space-lg);
  }


  .dax-card {
    background: var(--glass-bg);
    backdrop-filter: blur(10px);
    border: 1px solid var(--glass-border);
    border-radius: var(--radius-lg);
    overflow: hidden;
    transition: var(--transition-smooth);
  }

  .dax-card:hover {
    box-shadow: var(--shadow-md);
    border-color: var(--color-primary);
  }

  .dax-card.highlighted {
    border-color: var(--color-success);
    box-shadow: 0 0 20px rgba(67, 233, 123, 0.3);
  }

  .dax-card.dimmed {
    opacity: 0.5;
  }

  .dax-card-header {
    padding: var(--space-lg);
    background: var(--bg-secondary);
    border-bottom: 1px solid var(--glass-border);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .measure-info {
    display: flex;
    align-items: center;
    gap: var(--space-md);
    flex: 1;
    min-width: 0;
  }

  .measure-icon {
    width: 48px;
    height: 48px;
    background: var(--gradient-primary);
    color: white;
    border-radius: var(--radius-md);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    flex-shrink: 0;
  }

  .measure-details {
    flex: 1;
    min-width: 0;
  }

  .measure-name {
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--text-primary);
    margin: 0 0 var(--space-xs) 0;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .measure-name mark {
    background: var(--gradient-warning);
    color: var(--text-primary);
    padding: 0 2px;
  }

  .measure-metadata {
    display: flex;
    gap: var(--space-md);
    flex-wrap: wrap;
  }

  .metadata-item {
    display: flex;
    align-items: center;
    gap: var(--space-xs);
    font-size: 0.875rem;
    color: var(--text-secondary);
  }

  .metadata-item i {
    font-size: 0.75rem;
    opacity: 0.7;
  }







  .measure-actions {
    display: flex;
    gap: var(--space-sm);
  }

  /* DAX Card Content */
  .dax-card-content {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.4s ease-out, padding 0.4s ease-out;
  }

  .dax-card.expanded .dax-card-content {
    max-height: 1000px;
    padding: var(--space-lg);
  }

  .code-container {
    background: var(--bg-primary);
    border: 1px solid var(--glass-border);
    border-radius: var(--radius-md);
    overflow: hidden;
  }

  .code-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-sm) var(--space-md);
    background: var(--bg-secondary);
    border-bottom: 1px solid var(--glass-border);
  }

  .code-label {
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--text-secondary);
  }

  .code-actions {
    display: flex;
    gap: var(--space-xs);
  }

  .code-action {
    background: transparent;
    border: 1px solid var(--glass-border);
    color: var(--text-secondary);
    padding: 4px 8px;
    border-radius: var(--radius-sm);
    font-size: 0.75rem;
    cursor: pointer;
    transition: var(--transition-fast);
  }

  .code-action:hover {
    background: var(--bg-hover);
    border-color: var(--color-primary);
    color: var(--color-primary);
  }

  /* Code styling */
  .code-container pre {
    margin: 0;
    padding: var(--space-md);
    max-height: 400px;
    overflow: auto;
    font-size: 0.875rem;
    line-height: 1.6;
  }

  .code-container code {
    font-family: 'JetBrains Mono', 'Courier New', monospace;
  }

  .code-container code mark {
    background: rgba(255, 193, 7, 0.3);
    color: inherit;
    padding: 2px;
    border-radius: 2px;
  }

  /* Measure Analysis */
  .measure-analysis {
    margin-top: var(--space-lg);
    padding: var(--space-lg);
    background: var(--bg-secondary);
    border-radius: var(--radius-md);
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--space-xl);
  }

  .analysis-section h4 {
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: var(--space-sm);
    display: flex;
    align-items: center;
    gap: var(--space-xs);
  }

  .analysis-section h4 i {
    color: var(--color-primary);
    font-size: 0.875rem;
  }

  .function-tags {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-xs);
  }

  .function-tag {
    background: var(--gradient-primary);
    color: white;
    padding: 2px 8px;
    border-radius: var(--radius-full);
    font-size: 0.75rem;
    font-weight: 500;
  }

  .reference-list {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-xs);
  }

  .reference-item {
    background: var(--glass-bg);
    border: 1px solid var(--glass-border);
    color: var(--text-primary);
    padding: 2px 8px;
    border-radius: var(--radius-full);
    font-size: 0.75rem;
    font-weight: 500;
    cursor: pointer;
    transition: var(--transition-fast);
  }

  .reference-item:hover {
    background: var(--bg-hover);
    border-color: var(--color-primary);
    color: var(--color-primary);
  }

  .no-references {
    font-size: 0.875rem;
    color: var(--text-muted);
    font-style: italic;
  }

  /* Similarity Analysis Modal */
  .modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(5px);
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: var(--space-lg);
  }

  .modal-content {
    background: var(--bg-primary);
    border: 1px solid var(--glass-border);
    border-radius: var(--radius-xl);
    max-width: 800px;
    width: 100%;
    max-height: 90vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }

  .modal-content.large {
    max-width: 1200px;
  }

  .modal-header {
    padding: var(--space-xl);
    background: var(--bg-secondary);
    border-bottom: 1px solid var(--glass-border);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .modal-title {
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--text-primary);
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    margin: 0;
  }

  .modal-close {
    background: transparent;
    border: none;
    color: var(--text-secondary);
    font-size: 1.5rem;
    cursor: pointer;
    padding: var(--space-sm);
    border-radius: var(--radius-md);
    transition: var(--transition-fast);
  }

  .modal-close:hover {
    background: var(--bg-hover);
    color: var(--text-primary);
  }

  .modal-body {
    flex: 1;
    overflow-y: auto;
    padding: var(--space-xl);
  }

  /* Similarity Controls */
  .similarity-controls {
    display: grid;
    grid-template-columns: 1fr auto;
    gap: var(--space-xl);
    margin-bottom: var(--space-xl);
    padding-bottom: var(--space-xl);
    border-bottom: 1px solid var(--glass-border);
  }

  .control-group label {
    display: block;
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--text-secondary);
    margin-bottom: var(--space-sm);
  }

  .threshold-control {
    display: flex;
    align-items: center;
    gap: var(--space-md);
  }

  .threshold-control input[type="range"] {
    flex: 1;
    accent-color: var(--color-primary);
  }

  .threshold-value {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--color-primary);
    min-width: 50px;
    text-align: right;
  }

  .similarity-stats {
    display: flex;
    gap: var(--space-xl);
  }

  .stat-item {
    text-align: center;
  }

  .stat-value {
    display: block;
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--text-primary);
    line-height: 1;
  }

  .stat-label {
    font-size: 0.75rem;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-top: 0.25rem;
  }

  /* Similarity Results */
  .results-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-lg);
  }

  .results-header h3 {
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--text-primary);
    margin: 0;
  }

  .similarity-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: var(--space-lg);
  }

  .similarity-card {
    background: var(--glass-bg);
    border: 1px solid var(--glass-border);
    border-radius: var(--radius-lg);
    padding: var(--space-lg);
    transition: var(--transition-fast);
  }

  .similarity-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
    border-color: var(--color-primary);
  }

  .similarity-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-md);
  }

  .similarity-measures {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    font-size: 0.875rem;
    font-weight: 500;
  }

  .measure-1,
  .measure-2 {
    color: var(--text-primary);
    padding: 2px 8px;
    background: var(--bg-secondary);
    border-radius: var(--radius-sm);
  }

  .similarity-measures i {
    color: var(--text-secondary);
    font-size: 0.75rem;
  }

  .similarity-score {
    font-size: 1.125rem;
    font-weight: 700;
    padding: 4px 12px;
    border-radius: var(--radius-full);
  }

  .similarity-score.very-high {
    background: rgba(255, 0, 0, 0.2);
    color: #ff0000;
  }

  .similarity-score.high {
    background: rgba(255, 152, 0, 0.2);
    color: #ff9800;
  }

  .similarity-score.medium {
    background: rgba(255, 193, 7, 0.2);
    color: #ffc107;
  }

  .similarity-score.low {
    background: rgba(76, 175, 80, 0.2);
    color: #4caf50;
  }

  .similarity-actions {
    display: flex;
    gap: var(--space-sm);
  }

  .action-button.small {
    padding: var(--space-xs) var(--space-sm);
    font-size: 0.875rem;
  }

  .no-similar-measures {
    text-align: center;
    padding: var(--space-2xl);
    color: var(--text-secondary);
    font-style: italic;
  }

  /* Loading Overlay */
  .loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(5px);
    z-index: 2000;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .loading-content {
    text-align: center;
  }

  .loading-spinner {
    width: 60px;
    height: 60px;
    border: 3px solid var(--glass-border);
    border-radius: 50%;
    border-top-color: var(--color-primary);
    animation: spin 1s ease-in-out infinite;
    margin: 0 auto var(--space-lg);
  }

  .loading-text {
    color: white;
    font-size: 1.125rem;
    font-weight: 500;
  }

  /* Comparison Modal */
  .comparison-modal {
    max-width: 800px;
    margin: 0 auto;
  }

  .comparison-modal h3 {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: var(--space-lg);
  }

  .comparison-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--space-lg);
    margin-bottom: var(--space-lg);
  }

  .comparison-pane {
    background: var(--bg-secondary);
    border: 1px solid var(--glass-border);
    border-radius: var(--radius-md);
    padding: var(--space-md);
    overflow: hidden;
  }

  .comparison-pane h4 {
    font-size: 1rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: var(--space-sm);
    padding-bottom: var(--space-sm);
    border-bottom: 1px solid var(--glass-border);
  }

  .comparison-pane pre {
    margin: 0;
    max-height: 300px;
    overflow: auto;
    font-size: 0.875rem;
  }

  .similarity-details {
    text-align: center;
    padding: var(--space-md);
    background: var(--bg-secondary);
    border-radius: var(--radius-md);
    font-size: 1rem;
  }

  /* Responsive Design */
  @media (max-width: 1200px) {
    .search-filter-container {
      flex-direction: column;
    }

    .filter-section {
      width: 100%;
    }
  }

  @media (max-width: 768px) {
    .measure-analysis {
      grid-template-columns: 1fr;
    }

    .similarity-controls {
      grid-template-columns: 1fr;
    }

    .similarity-stats {
      flex-wrap: wrap;
    }

    .similarity-grid {
      grid-template-columns: 1fr;
    }

    .comparison-grid {
      grid-template-columns: 1fr;
    }

    .table-toolbar.enhanced {
      flex-direction: column;
      align-items: flex-start;
      gap: var(--space-md);
    }

    .table-actions {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-sm);
    }
  }

  /* Animations */
  @keyframes spin {
    to {
      transform: rotate(360deg);
    }
  }
</style>
{% endblock %}