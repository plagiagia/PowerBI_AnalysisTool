{% extends "base.html" %}
{% block title %}Source Explorer - Power BI Analysis Tool{% endblock %}

{% block header_icon %}<i class="fas fa-database"></i>{% endblock %}
{% block header_title %}Source Explorer{% endblock %}
{% block header_subtitle %}Examine and analyze the M queries that form your report's data sources{% endblock %}

{% block header_stats %}
<div class="quick-stat">
  <span class="stat-number">{{ m_queries_info|length if m_queries_info else 0 }}</span>
  <span class="stat-label">Data Sources</span>
</div>
<div class="quick-stat">
  <span class="stat-number">{{ (m_queries_info|map(attribute='m_query')|map('length')|sum / 1000)|round|int if
    m_queries_info else 0 }}</span>
  <span class="stat-label">Total Lines (K)</span>
</div>
{% endblock %}

{% block head %}
<!-- Include Prism.js CSS for syntax highlighting -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.25.0/themes/prism.min.css" />
<!-- Include Prism.js PowerQuery language support -->
<link rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.25.0/plugins/line-numbers/prism-line-numbers.min.css" />
{% endblock %}

{% block breadcrumbs %}
<li>
  <a href="/source-explorer"><i class="fas fa-database"></i><span class="breadcrumb-text">Source Explorer</span></a>
</li>
{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="page-header">
  <h1 class="page-title"><i class="fas fa-database"></i> Source Explorer</h1>
  <p class="page-description">
    Examine the M queries that form your report's data sources.
  </p>
</div>

<!-- Loading Indicator -->
<div id="loadingIndicator" class="loading-overlay" style="display: none;">
  <div class="loading-spinner"></div>
  <div class="loading-text">Analyzing sources...</div>
</div>

<!-- Source Distribution Info Table -->
<div class="source-info-section">
  <div class="info-header">
    <h2 class="info-title">
      <i class="fas fa-chart-pie"></i>
      Source Distribution
    </h2>
    <button id="toggleInfoDetails" class="toggle-details-btn" aria-label="Toggle source details">
      <i class="fas fa-chevron-down"></i>
      <span>Show Details</span>
    </button>
  </div>

  <div class="info-summary">
    <div class="summary-cards">
      <div class="summary-card">
        <div class="card-icon sql">
          <i class="fas fa-database"></i>
        </div>
        <div class="card-content">
          <div class="card-number" id="sqlCount">0</div>
          <div class="card-label">SQL Sources</div>
        </div>
      </div>

      <div class="summary-card">
        <div class="card-icon file">
          <i class="fas fa-file-excel"></i>
        </div>
        <div class="card-content">
          <div class="card-number" id="fileCount">0</div>
          <div class="card-label">File Sources</div>
        </div>
      </div>

      <div class="summary-card">
        <div class="card-icon web">
          <i class="fas fa-globe"></i>
        </div>
        <div class="card-content">
          <div class="card-number" id="webCount">0</div>
          <div class="card-label">Web Sources</div>
        </div>
      </div>

      <div class="summary-card">
        <div class="card-icon reference">
          <i class="fas fa-link"></i>
        </div>
        <div class="card-content">
          <div class="card-number" id="referenceCount">0</div>
          <div class="card-label">Query References</div>
        </div>
      </div>

      <div class="summary-card">
        <div class="card-icon manual">
          <i class="fas fa-edit"></i>
        </div>
        <div class="card-content">
          <div class="card-number" id="manualCount">0</div>
          <div class="card-label">Manual/Other</div>
        </div>
      </div>
    </div>
  </div>

  <div class="info-details" id="infoDetails" style="display: none;">
    <div class="details-grid">
      <div class="details-section">
        <h3 class="section-title">
          <i class="fas fa-server"></i>
          Database Sources
        </h3>
        <div class="source-list" id="databaseSources">
          <div class="loading-placeholder">Loading...</div>
        </div>
      </div>

      <div class="details-section">
        <h3 class="section-title">
          <i class="fas fa-file-alt"></i>
          File Sources
        </h3>
        <div class="source-list" id="fileSources">
          <div class="loading-placeholder">Loading...</div>
        </div>
      </div>

      <div class="details-section">
        <h3 class="section-title">
          <i class="fas fa-cloud"></i>
          Web & API Sources
        </h3>
        <div class="source-list" id="webSources">
          <div class="loading-placeholder">Loading...</div>
        </div>
      </div>

      <div class="details-section">
        <h3 class="section-title">
          <i class="fas fa-project-diagram"></i>
          Query References
        </h3>
        <div class="source-list" id="referenceSources">
          <div class="loading-placeholder">Loading...</div>
        </div>
      </div>

      <div class="details-section">
        <h3 class="section-title">
          <i class="fas fa-tools"></i>
          Other Sources
        </h3>
        <div class="source-list" id="otherSources">
          <div class="loading-placeholder">Loading...</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Control Panel -->
<div class="control-panel">
  <!-- Search Bar -->
  <div class="search-container">
    <div class="search-input-wrapper">
      <i class="fas fa-search"></i>
      <input type="text" id="searchQueries" placeholder="Search in queries..." aria-label="Search in M queries" />
      <button id="clearSearch" class="clear-search" style="display: none" aria-label="Clear search">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="search-count" aria-live="polite"></div>
  </div>

  <!-- Quick filters -->
  <div class="quick-filters">
    <button class="filter-chip" data-filter="sql">
      <i class="fas fa-database"></i> SQL Only
    </button>
    <button class="filter-chip" data-filter="file">
      <i class="fas fa-file"></i> Files Only
    </button>
    <button class="filter-chip" data-filter="web">
      <i class="fas fa-globe"></i> Web Only
    </button>
    <button class="filter-chip active" data-filter="all">
      <i class="fas fa-border-all"></i> All Sources
    </button>
  </div>
</div>

<!-- Queries Section -->
<div id="queriesContainer" class="queries-section improved">
  <div class="table-toolbar">
    <div class="table-info">
      <div class="results-count">
        <span id="resultCount">{{ m_queries_info|length }}</span> queries found
      </div>
    </div>
    <div class="table-actions">
      <button id="exportQueries" class="action-button outline">
        <i class="fas fa-download"></i> Export Queries
      </button>
      <div class="view-toggle">
        <button id="expandAll" class="action-button secondary">
          <i class="fas fa-expand-alt"></i> Expand All
        </button>
        <button id="collapseAll" class="action-button secondary">
          <i class="fas fa-compress-alt"></i> Collapse All
        </button>
      </div>
    </div>
  </div>

  <!-- Queries List with Improved Layout -->
  <div id="queriesList" class="improved-queries-list">
    {% for query in m_queries_info %}
    <div class="improved-query-card" data-table="{{ query.table_name }}" data-query-index="{{ loop.index0 }}">
      <!-- Card Header with Better Spacing -->
      <div class="improved-query-header">
        <div class="query-title-section">
          <div class="table-icon-wrapper">
            <i class="fas fa-database"></i>
          </div>
          <div class="query-title-content">
            <h3 class="improved-query-name">{{ query.table_name }}</h3>
            <div class="query-meta">
              <span class="query-type">
                <i class="fas fa-code"></i>
                M Query
              </span>
              <span class="query-lines">
                <i class="fas fa-file-lines"></i>
                <span class="line-count">{{ query.m_query.count('\n') + 1 }}</span> lines
              </span>
              <span class="query-source-type" data-table="{{ query.table_name }}">
                <i class="fas fa-plug"></i>
                <span class="source-type-text">Analyzing...</span>
              </span>
            </div>
          </div>
        </div>
        <div class="improved-query-actions">
          <button class="icon-button copy-name" title="Copy table name" data-copy="{{ query.table_name }}">
            <i class="fas fa-tag"></i>
          </button>
          <button class="icon-button copy-query" title="Copy query" data-table="{{ query.table_name }}">
            <i class="fas fa-copy"></i>
          </button>
          <button class="icon-button toggle-expand" title="Toggle view" aria-expanded="false">
            <i class="fas fa-chevron-down"></i>
          </button>
        </div>
      </div>

      <!-- Expanded Content with Better Layout -->
      <div class="improved-query-content">
        <div class="improved-code-container">
          <div class="code-header">
            <span class="code-label">
              <i class="fas fa-code"></i>
              M Query Definition
            </span>
            <div class="code-actions">
              <button class="code-action-btn toggle-line-numbers" title="Toggle line numbers">
                <i class="fas fa-list-ol"></i>
              </button>
              <button class="code-action-btn toggle-wrap" title="Toggle word wrap">
                <i class="fas fa-text-width"></i>
              </button>
              <button class="copy-button" data-table="{{ query.table_name }}">
                <i class="fas fa-copy"></i> Copy
              </button>
            </div>
          </div>
          <div class="code-wrapper">
            <pre
              class="line-numbers"><code class="language-powerquery" data-original-content="{{ query.m_query | e }}">{{ query.m_query }}</code></pre>
          </div>
        </div>

        <!-- Query Analysis Section -->
        <div class="query-analysis" style="display: none;">
          <div class="analysis-header">
            <i class="fas fa-microscope"></i>
            <span>Query Analysis</span>
          </div>
          <div class="analysis-content">
            <div class="analysis-item">
              <strong>Source Type:</strong> <span class="analysis-source-type">-</span>
            </div>
            <div class="analysis-item">
              <strong>Connection:</strong> <span class="analysis-connection">-</span>
            </div>
            <div class="analysis-item">
              <strong>Dependencies:</strong> <span class="analysis-dependencies">-</span>
            </div>
          </div>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>

  <!-- Empty State -->
  <div id="emptyState" class="empty-state" style="display: none">
    <div class="empty-state-icon">
      <i class="fas fa-search"></i>
    </div>
    <h3 class="empty-state-title">No matching queries found</h3>
    <p class="empty-state-message">Try adjusting your search or filters.</p>
    <button id="clearEmptyState" class="action-button primary">
      <i class="fas fa-undo"></i> Clear Search
    </button>
  </div>
</div>

<!-- Hidden data for JavaScript -->
<script type="application/json" id="mQueriesData">
{{ m_queries_info | tojson | safe }}
</script>

{% endblock %}

{% block scripts %}
<!-- Include Prism.js for syntax highlighting -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.25.0/prism.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.25.0/components/prism-powerquery.min.js"></script>
<script
  src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.25.0/plugins/line-numbers/prism-line-numbers.min.js"></script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    // DOM Elements
    const searchQueries = document.getElementById("searchQueries");
    const clearSearch = document.getElementById("clearSearch");
    const resultCount = document.getElementById("resultCount");
    const queriesList = document.getElementById("queriesList");
    const queryCards = document.querySelectorAll(".improved-query-card");
    const emptyState = document.getElementById("emptyState");
    const clearEmptyStateBtn = document.getElementById("clearEmptyState");
    const expandAllBtn = document.getElementById("expandAll");
    const collapseAllBtn = document.getElementById("collapseAll");
    const exportQueriesBtn = document.getElementById("exportQueries");
    const searchCount = document.querySelector(".search-count");
    const toggleInfoDetails = document.getElementById("toggleInfoDetails");
    const infoDetails = document.getElementById("infoDetails");
    const loadingIndicator = document.getElementById("loadingIndicator");
    const quickFilterButtons = document.querySelectorAll(".filter-chip");

    // Get M queries data from the template
    const mQueriesDataElement = document.getElementById("mQueriesData");
    const mQueriesData = mQueriesDataElement ? JSON.parse(mQueriesDataElement.textContent) : [];

    // State variables
    let currentVisibleItems = queryCards.length;
    let activeFilter = 'all';
    let sourceAnalysis = {
      sql: 0,
      file: 0,
      web: 0,
      manual: 0,
      reference: 0,
      details: {
        databases: [],
        files: [],
        web: [],
        other: [],
        references: []
      }
    };

    // Initialize
    init();

    async function init() {
      try {
        showLoading();
        await analyzeSourceTypes();
        updateInfoTable();
        setupEventListeners();
        initializeCodeFeatures();
        hideLoading();
      } catch (error) {
        console.error("Initialization error:", error);
        hideLoading();
        showError("Failed to initialize source explorer");
      }
    }

    function showLoading() {
      if (loadingIndicator) {
        loadingIndicator.style.display = "flex";
      }
    }

    function hideLoading() {
      if (loadingIndicator) {
        loadingIndicator.style.display = "none";
      }
    }

    function showError(message) {
      if (window.PowerBIExplorer && window.PowerBIExplorer.showNotification) {
        window.PowerBIExplorer.showNotification(message, "error");
      } else {
        console.error(message);
      }
    }

    /**
     * Analyze source types from M queries with better error handling
     */
    async function analyzeSourceTypes() {
      return new Promise((resolve) => {
        queryCards.forEach((card, index) => {
          try {
            const tableName = card.getAttribute("data-table");
            const queryData = mQueriesData[index];
            const mQuery = queryData ? queryData.m_query : "";

            const sourceInfo = identifySourceType(mQuery, tableName);

            // Update counters
            sourceAnalysis[sourceInfo.category]++;

            // Add to details with enhanced structure
            const categoryKey = getCategoryDetailsKey(sourceInfo.category);
            sourceAnalysis.details[categoryKey].push({
              table: tableName,
              type: sourceInfo.type,
              details: sourceInfo.details,
              connectionKey: sourceInfo.connectionKey || sourceInfo.details
            });

            // Update the query card with source type
            updateQueryCardSourceType(card, sourceInfo);

            // Update analysis section
            updateQueryAnalysis(card, sourceInfo);
          } catch (error) {
            console.error(`Error analyzing source for ${card.getAttribute("data-table")}:`, error);
          }
        });
        resolve();
      });
    }

    function updateQueryCardSourceType(card, sourceInfo) {
      const sourceTypeElement = card.querySelector(".source-type-text");
      if (sourceTypeElement) {
        sourceTypeElement.textContent = sourceInfo.type;
      }

      // Add source type class to query type span
      const querySourceSpan = card.querySelector(".query-source-type");
      if (querySourceSpan) {
        querySourceSpan.classList.add(`source-${sourceInfo.category}`);
      }

      // Add category data attribute for filtering
      card.setAttribute("data-source-category", sourceInfo.category);
    }

    function updateQueryAnalysis(card, sourceInfo) {
      const analysisSection = card.querySelector(".query-analysis");
      if (analysisSection) {
        analysisSection.querySelector(".analysis-source-type").textContent = sourceInfo.type;
        analysisSection.querySelector(".analysis-connection").textContent = sourceInfo.details;

        // Extract dependencies (references to other queries)
        const queryIndex = parseInt(card.getAttribute("data-query-index"));
        const queryData = mQueriesData[queryIndex];
        if (queryData) {
          const dependencies = extractQueryDependencies(queryData.m_query);
          analysisSection.querySelector(".analysis-dependencies").textContent =
            dependencies.length > 0 ? dependencies.join(", ") : "None";
        }
      }
    }

    function extractQueryDependencies(mQuery) {
      const dependencies = [];
      const regex = /(\w+)(?=\s*\[|\s*\{|\s*\()/g;
      const matches = mQuery.match(regex) || [];

      matches.forEach(match => {
        // Check if this matches any table name
        if (mQueriesData.some(q => q.table_name === match) && !dependencies.includes(match)) {
          dependencies.push(match);
        }
      });

      return dependencies;
    }

    /**
     * Enhanced source type identification
     */
    function identifySourceType(mQuery, tableName) {
      const query = mQuery.toLowerCase();

      // SQL Database sources
      if (query.includes('sql.database(')) {
        const serverMatch = mQuery.match(/Sql\.Database\s*\(\s*"([^"]+)"/i);
        const dbMatch = mQuery.match(/Sql\.Database\s*\([^,]+,\s*"([^"]+)"/i);
        const server = serverMatch ? serverMatch[1] : 'Unknown Server';
        const database = dbMatch ? dbMatch[1] : 'Unknown Database';
        const connectionKey = `${server} / ${database}`;
        return {
          category: 'sql',
          type: 'SQL Server',
          details: connectionKey,
          connectionKey: connectionKey
        };
      }

      if (query.includes('oracle.database(')) {
        const connectionDetail = extractConnectionDetail(mQuery, 'Oracle.Database');
        return {
          category: 'sql',
          type: 'Oracle Database',
          details: connectionDetail,
          connectionKey: connectionDetail
        };
      }

      if (query.includes('mysql.database(')) {
        const connectionDetail = extractConnectionDetail(mQuery, 'MySQL.Database');
        return {
          category: 'sql',
          type: 'MySQL',
          details: connectionDetail,
          connectionKey: connectionDetail
        };
      }

      if (query.includes('postgresql.database(')) {
        const connectionDetail = extractConnectionDetail(mQuery, 'PostgreSQL.Database');
        return {
          category: 'sql',
          type: 'PostgreSQL',
          details: connectionDetail,
          connectionKey: connectionDetail
        };
      }

      // File sources
      if (query.includes('excel.workbook(')) {
        const fileDetail = extractFileDetail(mQuery, 'Excel.Workbook');
        return {
          category: 'file',
          type: 'Excel',
          details: fileDetail,
          connectionKey: fileDetail
        };
      }

      if (query.includes('csv.document(')) {
        const fileDetail = extractFileDetail(mQuery, 'Csv.Document');
        return {
          category: 'file',
          type: 'CSV',
          details: fileDetail,
          connectionKey: fileDetail
        };
      }

      if (query.includes('folder.contents(') || query.includes('folder.files(')) {
        const fileDetail = extractFileDetail(mQuery, 'Folder');
        return {
          category: 'file',
          type: 'Folder',
          details: fileDetail,
          connectionKey: fileDetail
        };
      }

      if (query.includes('json.document(')) {
        const fileDetail = extractFileDetail(mQuery, 'Json.Document');
        return {
          category: 'file',
          type: 'JSON',
          details: fileDetail,
          connectionKey: fileDetail
        };
      }

      if (query.includes('xml.document(') || query.includes('xml.tables(')) {
        const fileDetail = extractFileDetail(mQuery, 'Xml');
        return {
          category: 'file',
          type: 'XML',
          details: fileDetail,
          connectionKey: fileDetail
        };
      }

      // Web sources
      if (query.includes('web.contents(') || query.includes('web.page(')) {
        const webDetail = extractWebDetail(mQuery, 'Web');
        return {
          category: 'web',
          type: 'Web/API',
          details: webDetail,
          connectionKey: webDetail
        };
      }

      if (query.includes('odata.feed(')) {
        const webDetail = extractWebDetail(mQuery, 'OData.Feed');
        return {
          category: 'web',
          type: 'OData',
          details: webDetail,
          connectionKey: webDetail
        };
      }

      if (query.includes('sharepoint.')) {
        const sharePointDetail = extractSharePointDetail(mQuery);
        return {
          category: 'web',
          type: 'SharePoint',
          details: sharePointDetail,
          connectionKey: sharePointDetail
        };
      }

      if (query.includes('azurestorage.') || query.includes('azureblobs.')) {
        return {
          category: 'web',
          type: 'Azure Storage',
          details: 'Azure Storage Account',
          connectionKey: 'Azure Storage'
        };
      }

      // Query references - improved detection
      const referenceMatch = mQuery.match(/^\s*Source\s*=\s*(\w+)\s*$/im);
      if (referenceMatch) {
        const referencedQuery = referenceMatch[1];
        return {
          category: 'reference',
          type: 'Query Reference',
          details: `â†’ ${referencedQuery}`,
          connectionKey: 'Query References'
        };
      }

      // Manual/Embedded data
      if (query.includes('table.fromrows(') || query.includes('table.fromrecords(') ||
        query.includes('table.fromcolumns(') || query.includes('#table(')) {
        return {
          category: 'manual',
          type: 'Manual Table',
          details: 'Inline data definition',
          connectionKey: 'Manual Tables'
        };
      }

      // Default fallback
      return {
        category: 'manual',
        type: 'Custom/Other',
        details: 'Custom transformation',
        connectionKey: 'Other Sources'
      };
    }

    /**
     * Extract connection detail from M query
     */
    function extractConnectionDetail(mQuery, functionName) {
      const regex = new RegExp(`${functionName}\\s*\\(\\s*"([^"]+)"`, 'i');
      const match = mQuery.match(regex);
      return match ? match[1] : 'Connection details not found';
    }

    /**
     * Extract file detail from M query
     */
    function extractFileDetail(mQuery, functionName) {
      // Multiple patterns to match different file access methods
      const patterns = [
        new RegExp(`${functionName}[^(]*\\(\\s*"([^"]+)"`, 'i'),
        new RegExp(`File\\.Contents\\s*\\(\\s*"([^"]+)"`, 'i'),
        new RegExp(`Folder\\.Contents\\s*\\(\\s*"([^"]+)"`, 'i'),
        new RegExp(`Folder\\.Files\\s*\\(\\s*"([^"]+)"`, 'i')
      ];

      for (const pattern of patterns) {
        const match = mQuery.match(pattern);
        if (match) {
          const fullPath = match[1];
          const fileName = fullPath.split('\\').pop().split('/').pop();
          return fileName || fullPath;
        }
      }

      return 'File path not found';
    }

    /**
     * Extract web detail from M query
     */
    function extractWebDetail(mQuery, functionName) {
      const patterns = [
        new RegExp(`Web\\.Contents\\s*\\(\\s*"([^"]+)"`, 'i'),
        new RegExp(`Web\\.Page\\s*\\(\\s*Web\\.Contents\\s*\\(\\s*"([^"]+)"`, 'i'),
        new RegExp(`OData\\.Feed\\s*\\(\\s*"([^"]+)"`, 'i')
      ];

      for (const pattern of patterns) {
        const match = mQuery.match(pattern);
        if (match) {
          try {
            const url = new URL(match[1]);
            return url.hostname;
          } catch {
            return match[1];
          }
        }
      }

      return 'URL not found';
    }

    /**
     * Extract SharePoint detail from M query
     */
    function extractSharePointDetail(mQuery) {
      const patterns = [
        /SharePoint\.[^(]+\s*\(\s*"([^"]+)"/i,
        /SharePoint\.Tables\s*\(\s*"([^"]+)"/i,
        /SharePoint\.Files\s*\(\s*"([^"]+)"/i
      ];

      for (const pattern of patterns) {
        const match = mQuery.match(pattern);
        if (match) {
          try {
            const url = new URL(match[1]);
            return url.hostname;
          } catch {
            return match[1];
          }
        }
      }

      return 'SharePoint site not found';
    }

    /**
     * Get category details key
     */
    function getCategoryDetailsKey(category) {
      const mapping = {
        'sql': 'databases',
        'file': 'files',
        'web': 'web',
        'manual': 'other',
        'reference': 'references'
      };
      return mapping[category] || 'other';
    }

    /**
     * Update info table with analysis results
     */
    function updateInfoTable() {
      // Update summary cards with animation
      animateCounter(document.getElementById("sqlCount"), sourceAnalysis.sql);
      animateCounter(document.getElementById("fileCount"), sourceAnalysis.file);
      animateCounter(document.getElementById("webCount"), sourceAnalysis.web);
      animateCounter(document.getElementById("manualCount"), sourceAnalysis.manual);
      animateCounter(document.getElementById("referenceCount"), sourceAnalysis.reference);

      // Update details sections
      updateDetailsSection("databaseSources", sourceAnalysis.details.databases);
      updateDetailsSection("fileSources", sourceAnalysis.details.files);
      updateDetailsSection("webSources", sourceAnalysis.details.web);
      updateDetailsSection("referenceSources", sourceAnalysis.details.references);
      updateDetailsSection("otherSources", sourceAnalysis.details.other);
    }

    /**
     * Animate counter
     */
    function animateCounter(element, target) {
      if (!element) return;

      let current = 0;
      const increment = target / 20;
      const timer = setInterval(() => {
        current += increment;
        if (current >= target) {
          current = target;
          clearInterval(timer);
        }
        element.textContent = Math.floor(current);
      }, 50);
    }

    /**
     * Update a details section with hierarchical grouping
     */
    function updateDetailsSection(elementId, sources) {
      const element = document.getElementById(elementId);
      if (!element) return;

      // Remove loading placeholder
      const placeholder = element.querySelector(".loading-placeholder");
      if (placeholder) placeholder.remove();

      if (sources.length === 0) {
        element.innerHTML = '<div class="no-sources">No sources of this type found</div>';
        return;
      }

      // Group by type, then by connection
      const grouped = {};
      sources.forEach(source => {
        if (!grouped[source.type]) {
          grouped[source.type] = {};
        }
        const connectionKey = source.connectionKey || source.details;
        if (!grouped[source.type][connectionKey]) {
          grouped[source.type][connectionKey] = [];
        }
        grouped[source.type][connectionKey].push(source);
      });

      let html = '';
      Object.keys(grouped).forEach(sourceType => {
        const totalTables = Object.values(grouped[sourceType]).flat().length;
        html += `
                <div class="source-type-group">
                    <div class="source-type-header" role="button" tabindex="0" aria-expanded="false">
                        <i class="fas fa-chevron-right"></i>
                        <span class="source-type-title">${sourceType}</span>
                        <span class="source-type-count">${totalTables}</span>
                    </div>
                    <div class="source-type-content" style="display: none;">
            `;

        Object.keys(grouped[sourceType]).forEach(connectionKey => {
          const tables = grouped[sourceType][connectionKey];
          html += `
                    <div class="connection-group">
                        <div class="connection-header">
                            <i class="fas fa-server"></i>
                            <span class="connection-details">${connectionKey}</span>
                            <span class="table-count">${tables.length} table${tables.length !== 1 ? 's' : ''}</span>
                        </div>
                        <div class="connection-tables">
                `;

          tables.forEach(table => {
            html += `
                        <div class="table-item" data-table="${table.table}">
                            <i class="fas fa-table"></i>
                            <span class="table-name">${table.table}</span>
                        </div>
                    `;
          });

          html += `
                        </div>
                    </div>
                `;
        });

        html += `
                    </div>
                </div>
            `;
      });

      element.innerHTML = html;

      // Add click handlers for collapsible groups
      element.querySelectorAll('.source-type-header').forEach(header => {
        header.addEventListener('click', function () {
          toggleCollapsible(this);
        });

        // Keyboard support
        header.addEventListener('keydown', function (e) {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            toggleCollapsible(this);
          }
        });
      });

      // Add click handlers for table items
      element.querySelectorAll('.table-item').forEach(item => {
        item.addEventListener('click', function () {
          const tableName = this.getAttribute('data-table');
          scrollToQuery(tableName);
        });
      });
    }

    function toggleCollapsible(header) {
      const content = header.nextElementSibling;
      const icon = header.querySelector('i');
      const isOpen = content.style.display !== 'none';

      content.style.display = isOpen ? 'none' : 'block';
      icon.classList.toggle('fa-chevron-right', isOpen);
      icon.classList.toggle('fa-chevron-down', !isOpen);
      header.setAttribute('aria-expanded', !isOpen);
    }

    function scrollToQuery(tableName) {
      const card = document.querySelector(`.improved-query-card[data-table="${tableName}"]`);
      if (card) {
        card.scrollIntoView({ behavior: 'smooth', block: 'center' });
        // Flash highlight
        card.classList.add('highlight-flash');
        setTimeout(() => card.classList.remove('highlight-flash'), 2000);
      }
    }

    /**
     * Set up event listeners for interactive elements
     */
    function setupEventListeners() {
      // Toggle info details
      if (toggleInfoDetails) {
        toggleInfoDetails.addEventListener("click", function () {
          const isVisible = infoDetails.style.display !== "none";
          infoDetails.style.display = isVisible ? "none" : "block";

          const icon = this.querySelector("i");
          const text = this.querySelector("span");

          icon.className = isVisible ? "fas fa-chevron-down" : "fas fa-chevron-up";
          text.textContent = isVisible ? "Show Details" : "Hide Details";
        });
      }

      // Search functionality
      if (searchQueries) {
        let searchTimeout;
        searchQueries.addEventListener("input", function () {
          clearTimeout(searchTimeout);
          const value = this.value;

          if (clearSearch) {
            clearSearch.style.display = value ? "block" : "none";
          }

          // Debounce search
          searchTimeout = setTimeout(() => performSearch(value), 300);
        });
      }

      // Clear search button
      if (clearSearch) {
        clearSearch.addEventListener("click", function () {
          if (searchQueries) {
            searchQueries.value = "";
            clearSearch.style.display = "none";
            performSearch("");
            searchQueries.focus();
          }
        });
      }

      // Clear empty state button
      if (clearEmptyStateBtn) {
        clearEmptyStateBtn.addEventListener("click", function () {
          if (searchQueries) {
            searchQueries.value = "";
            if (clearSearch) clearSearch.style.display = "none";
            activeFilter = 'all';
            updateQuickFilters();
            performSearch("");
            searchQueries.focus();
          }
        });
      }

      // Expand all button
      if (expandAllBtn) {
        expandAllBtn.addEventListener("click", function () {
          const visibleCards = Array.from(queryCards).filter(card => card.style.display !== "none");
          visibleCards.forEach(card => {
            if (!card.classList.contains("expanded")) {
              const button = card.querySelector(".toggle-expand");
              toggleQueryCard(card, button);
            }
          });
        });
      }

      // Collapse all button
      if (collapseAllBtn) {
        collapseAllBtn.addEventListener("click", function () {
          const visibleCards = Array.from(queryCards).filter(card => card.style.display !== "none");
          visibleCards.forEach(card => {
            if (card.classList.contains("expanded")) {
              const button = card.querySelector(".toggle-expand");
              toggleQueryCard(card, button);
            }
          });
        });
      }

      // Export queries button
      if (exportQueriesBtn) {
        exportQueriesBtn.addEventListener("click", exportAllQueries);
      }

      // Toggle expand buttons for each query
      document.querySelectorAll(".toggle-expand").forEach(button => {
        button.addEventListener("click", function (e) {
          e.stopPropagation();
          const card = this.closest(".improved-query-card");
          toggleQueryCard(card, this);
        });
      });

      // Copy table name buttons
      document.querySelectorAll(".copy-name").forEach(button => {
        button.addEventListener("click", function (e) {
          e.stopPropagation();
          const tableName = this.getAttribute("data-copy");
          copyToClipboardWithAnimation(this, tableName, "Table name");
        });
      });

      // Copy query buttons
      document.querySelectorAll(".copy-query").forEach(button => {
        button.addEventListener("click", function (e) {
          e.stopPropagation();
          const tableName = this.getAttribute("data-table");
          const card = this.closest(".improved-query-card");
          const codeElement = card.querySelector("code");
          if (codeElement) {
            const originalContent = codeElement.getAttribute("data-original-content") || codeElement.textContent;
            copyToClipboardWithAnimation(this, originalContent, "Query");
          }
        });
      });

      // Copy buttons in code headers
      document.querySelectorAll(".copy-button").forEach(button => {
        button.addEventListener("click", function (e) {
          e.stopPropagation();
          const container = this.closest(".improved-code-container");
          const codeElement = container.querySelector("code");
          if (codeElement) {
            const originalContent = codeElement.getAttribute("data-original-content") || codeElement.textContent;
            copyToClipboardWithAnimation(this, originalContent, "Query");
          }
        });
      });

      // Quick filter buttons
      quickFilterButtons.forEach(button => {
        button.addEventListener("click", function () {
          activeFilter = this.getAttribute("data-filter");
          updateQuickFilters();
          applyFilters();
        });
      });

      // Keyboard shortcuts
      document.addEventListener("keydown", function (e) {
        // Ctrl/Cmd + F for search focus
        if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
          e.preventDefault();
          if (searchQueries) searchQueries.focus();
        }

        // Escape to clear search
        if (e.key === 'Escape' && searchQueries && searchQueries.value) {
          searchQueries.value = "";
          if (clearSearch) clearSearch.style.display = "none";
          performSearch("");
        }
      });
    }

    function updateQuickFilters() {
      quickFilterButtons.forEach(button => {
        const filter = button.getAttribute("data-filter");
        button.classList.toggle("active", filter === activeFilter);
      });
    }

    function applyFilters() {
      const searchValue = searchQueries ? searchQueries.value : "";
      performSearch(searchValue);
    }

    /**
     * Initialize code features (line numbers, word wrap)
     */
    function initializeCodeFeatures() {
      // Toggle line numbers
      document.querySelectorAll(".toggle-line-numbers").forEach(button => {
        button.addEventListener("click", function (e) {
          e.stopPropagation();
          const pre = this.closest(".improved-code-container").querySelector("pre");
          pre.classList.toggle("line-numbers");
          Prism.highlightElement(pre.querySelector("code"));
        });
      });

      // Toggle word wrap
      document.querySelectorAll(".toggle-wrap").forEach(button => {
        button.addEventListener("click", function (e) {
          e.stopPropagation();
          const pre = this.closest(".improved-code-container").querySelector("pre");
          pre.classList.toggle("word-wrap");
        });
      });

      // Show analysis on expansion
      queryCards.forEach(card => {
        card.addEventListener("transitionend", function () {
          if (this.classList.contains("expanded")) {
            const analysisSection = this.querySelector(".query-analysis");
            if (analysisSection) {
              setTimeout(() => {
                analysisSection.style.display = "block";
              }, 100);
            }
          }
        });
      });
    }

    /**
     * Toggle expansion state of a query card with animation
     */
    function toggleQueryCard(card, button) {
      if (!card || !button) return;

      const isExpanding = !card.classList.contains("expanded");
      card.classList.toggle("expanded");

      // Update button
      button.innerHTML = isExpanding ?
        '<i class="fas fa-chevron-up"></i>' :
        '<i class="fas fa-chevron-down"></i>';
      button.setAttribute("title", isExpanding ? "Collapse" : "Expand");
      button.setAttribute("aria-expanded", isExpanding);

      // Hide analysis when collapsing
      if (!isExpanding) {
        const analysisSection = card.querySelector(".query-analysis");
        if (analysisSection) {
          analysisSection.style.display = "none";
        }
      }

      // Highlight code if expanding
      if (isExpanding) {
        const codeElement = card.querySelector("code");
        if (codeElement && !codeElement.classList.contains("highlighted")) {
          Prism.highlightElement(codeElement);
          codeElement.classList.add("highlighted");
        }
      }
    }

    /**
     * Enhanced search functionality
     */
    function performSearch(searchValue = "") {
      const normalizedSearch = searchValue.toLowerCase().trim();
      let visibleItems = 0;

      // Clear previous search highlights
      clearSearchHighlights();

      queryCards.forEach(card => {
        const tableName = card.getAttribute("data-table").toLowerCase();
        const sourceCategory = card.getAttribute("data-source-category");
        const queryIndex = parseInt(card.getAttribute("data-query-index"));
        const queryData = mQueriesData[queryIndex];
        const queryText = queryData ? queryData.m_query.toLowerCase() : "";

        // Apply category filter
        let categoryMatch = activeFilter === 'all' || sourceCategory === activeFilter;

        // Apply search filter
        let searchMatch = true;
        if (normalizedSearch) {
          searchMatch = tableName.includes(normalizedSearch) || queryText.includes(normalizedSearch);

          // Highlight matches
          if (searchMatch) {
            highlightSearchTermInCard(card, searchValue);
          }
        }

        const isVisible = categoryMatch && searchMatch;
        card.style.display = isVisible ? "" : "none";

        if (isVisible) visibleItems++;
      });

      // Update UI
      currentVisibleItems = visibleItems;
      updateResultCount();
      updateEmptyState();

      // Update search count
      if (searchCount) {
        if (normalizedSearch || activeFilter !== 'all') {
          searchCount.textContent = `${visibleItems} result${visibleItems !== 1 ? 's' : ''}`;
        } else {
          searchCount.textContent = "";
        }
      }
    }

    function clearSearchHighlights() {
      document.querySelectorAll(".search-highlight").forEach(el => {
        const text = el.textContent;
        const parent = el.parentNode;
        const textNode = document.createTextNode(text);
        parent.replaceChild(textNode, el);
        parent.normalize();
      });
    }

    function highlightSearchTermInCard(card, searchTerm) {
      // Highlight in table name
      const nameElement = card.querySelector(".improved-query-name");
      if (nameElement && nameElement.textContent.toLowerCase().includes(searchTerm.toLowerCase())) {
        highlightSearchTerm(nameElement, searchTerm);
      }

      // Highlight in expanded code if visible
      if (card.classList.contains("expanded")) {
        const codeElement = card.querySelector("code");
        if (codeElement) {
          const originalContent = codeElement.getAttribute("data-original-content") || codeElement.textContent;
          if (originalContent.toLowerCase().includes(searchTerm.toLowerCase())) {
            highlightCodeSearchTerm(codeElement, searchTerm, originalContent);
          }
        }
      }
    }

    function highlightSearchTerm(element, term) {
      if (!element || !term) return;

      const text = element.textContent;
      const regex = new RegExp(`(${escapeRegExp(term)})`, "gi");
      const highlightedText = text.replace(regex, '<span class="search-highlight">$1</span>');
      element.innerHTML = highlightedText;
    }

    function highlightCodeSearchTerm(codeElement, term, originalContent) {
      if (!codeElement || !term) return;

      // Store original content if not already stored
      if (!codeElement.hasAttribute('data-original-content')) {
        codeElement.setAttribute('data-original-content', originalContent);
      }

      const regex = new RegExp(`(${escapeRegExp(term)})`, "gi");
      const highlightedCode = originalContent.replace(regex, '<span class="search-highlight">$1</span>');
      codeElement.innerHTML = highlightedCode;

      // Re-apply syntax highlighting
      Prism.highlightElement(codeElement);
    }

    /**
     * Update the result count display
     */
    function updateResultCount() {
      if (resultCount) {
        resultCount.textContent = currentVisibleItems;
      }
    }

    /**
     * Update empty state visibility
     */
    function updateEmptyState() {
      if (emptyState) {
        emptyState.style.display = currentVisibleItems === 0 ? "flex" : "none";
      }

      if (queriesList) {
        queriesList.style.display = currentVisibleItems === 0 ? "none" : "";
      }
    }

    /**
     * Export all visible queries to a file
     */
    function exportAllQueries() {
      const visibleCards = Array.from(queryCards).filter(
        card => card.style.display !== "none"
      );

      if (visibleCards.length === 0) {
        showError("No queries to export");
        return;
      }

      const exportData = visibleCards.map(card => {
        const tableName = card.getAttribute("data-table");
        const queryIndex = parseInt(card.getAttribute("data-query-index"));
        const queryData = mQueriesData[queryIndex];
        const sourceType = card.querySelector(".source-type-text")?.textContent || "Unknown";

        return {
          tableName: tableName,
          sourceType: sourceType,
          query: queryData ? queryData.m_query : ""
        };
      });

      // Generate content
      const content = exportData.map(item => {
        return `-- Table: ${item.tableName}
-- Source Type: ${item.sourceType}
${item.query}

`;
      }).join('\r\n');

      // Create and download file
      const blob = new Blob([content], { type: "text/plain;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.setAttribute("href", url);
      link.setAttribute("download", `power_bi_m_queries_${new Date().toISOString().slice(0, 10)}.txt`);
      link.style.display = "none";
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);

      // Show notification
      if (window.PowerBIExplorer && window.PowerBIExplorer.showNotification) {
        window.PowerBIExplorer.showNotification(
          `Exported ${visibleCards.length} M queries successfully`,
          "success"
        );
      }
    }

    /**
     * Enhanced copy to clipboard with better feedback
     */
    function copyToClipboardWithAnimation(button, text, itemType = "Content") {
      if (!button) return;

      const originalHTML = button.innerHTML;
      button.disabled = true;
      button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

      // Use modern clipboard API with fallback
      if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(text)
          .then(() => {
            button.innerHTML = '<i class="fas fa-check"></i>';
            if (window.PowerBIExplorer && window.PowerBIExplorer.showNotification) {
              window.PowerBIExplorer.showNotification(
                `${itemType} copied to clipboard`,
                "success"
              );
            }
          })
          .catch((err) => {
            console.error("Copy failed:", err);
            fallbackCopy(text, button, originalHTML, itemType);
          })
          .finally(() => {
            setTimeout(() => {
              button.innerHTML = originalHTML;
              button.disabled = false;
            }, 2000);
          });
      } else {
        fallbackCopy(text, button, originalHTML, itemType);
      }
    }

    /**
     * Fallback copy method
     */
    function fallbackCopy(text, button, originalHTML, itemType) {
      try {
        const textArea = document.createElement("textarea");
        textArea.value = text;
        textArea.style.position = "fixed";
        textArea.style.opacity = "0";
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();

        const success = document.execCommand("copy");
        button.innerHTML = success ? '<i class="fas fa-check"></i>' : '<i class="fas fa-times"></i>';

        if (success && window.PowerBIExplorer && window.PowerBIExplorer.showNotification) {
          window.PowerBIExplorer.showNotification(
            `${itemType} copied to clipboard`,
            "success"
          );
        }

        document.body.removeChild(textArea);
      } catch (err) {
        console.error("Fallback copy failed:", err);
        button.innerHTML = '<i class="fas fa-times"></i>';
      }

      setTimeout(() => {
        button.innerHTML = originalHTML;
        button.disabled = false;
      }, 2000);
    }

    /**
     * Escape special characters in string for regex
     */
    function escapeRegExp(string) {
      return string.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
    }
  });
</script>

<style>
  /* Additional styles for improvements */
  .loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    backdrop-filter: blur(5px);
  }

  .loading-spinner {
    width: 50px;
    height: 50px;
    border: 3px solid var(--glass-border);
    border-radius: 50%;
    border-top-color: var(--color-primary);
    animation: spin 1s ease-in-out infinite;
  }

  .loading-text {
    color: white;
    margin-top: var(--space-lg);
    font-size: 1.125rem;
    font-weight: 500;
  }

  @keyframes spin {
    to {
      transform: rotate(360deg);
    }
  }

  .loading-placeholder {
    text-align: center;
    color: var(--text-muted);
    padding: var(--space-lg);
    font-style: italic;
  }

  /* Quick filters */
  .quick-filters {
    display: flex;
    gap: var(--space-sm);
    margin-top: var(--space-md);
    flex-wrap: wrap;
  }

  .filter-chip {
    background: var(--glass-bg);
    border: 1px solid var(--glass-border);
    color: var(--text-secondary);
    padding: var(--space-xs) var(--space-md);
    border-radius: var(--radius-full);
    font-size: 0.875rem;
    cursor: pointer;
    transition: var(--transition-fast);
    display: flex;
    align-items: center;
    gap: var(--space-xs);
    font-weight: 500;
  }

  .filter-chip:hover {
    background: var(--bg-hover);
    border-color: var(--color-primary);
    transform: translateY(-1px);
  }

  .filter-chip.active {
    background: var(--gradient-primary);
    color: white;
    border-color: transparent;
    box-shadow: var(--shadow-sm);
  }

  .filter-chip i {
    font-size: 0.75rem;
  }

  /* Query analysis section */
  .query-analysis {
    margin-top: var(--space-lg);
    padding: var(--space-lg);
    background: var(--bg-secondary);
    border-radius: var(--radius-md);
    border: 1px solid var(--glass-border);
    animation: fadeIn 0.3s ease-out;
  }

  .analysis-header {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    margin-bottom: var(--space-md);
    color: var(--color-primary);
    font-weight: 600;
  }

  .analysis-content {
    display: grid;
    gap: var(--space-sm);
  }

  .analysis-item {
    display: flex;
    gap: var(--space-sm);
    font-size: 0.875rem;
  }

  .analysis-item strong {
    color: var(--text-secondary);
    min-width: 120px;
  }

  .analysis-item span {
    color: var(--text-primary);
    font-family: 'JetBrains Mono', monospace;
  }

  /* Code action buttons */
  .code-action-btn {
    background: var(--glass-bg);
    border: 1px solid var(--glass-border);
    color: var(--text-secondary);
    padding: var(--space-xs) var(--space-sm);
    border-radius: var(--radius-sm);
    font-size: 0.875rem;
    cursor: pointer;
    transition: var(--transition-fast);
  }

  .code-action-btn:hover {
    background: var(--bg-hover);
    color: var(--color-primary);
    border-color: var(--color-primary);
  }

  /* Word wrap for code */
  pre.word-wrap {
    white-space: pre-wrap;
    word-wrap: break-word;
  }

  /* Highlight flash animation */
  @keyframes highlightFlash {
    0% {
      background-color: transparent;
    }

    50% {
      background-color: rgba(102, 126, 234, 0.2);
    }

    100% {
      background-color: transparent;
    }
  }

  .highlight-flash {
    animation: highlightFlash 2s ease-out;
  }

  /* Table item hover in details */
  .table-item {
    cursor: pointer;
  }

  .table-item:hover {
    background: var(--gradient-primary);
    color: white;
  }

  .table-item:hover i {
    color: white;
  }

  /* Improved accessibility */
  .source-type-header:focus {
    outline: 2px solid var(--color-primary);
    outline-offset: 2px;
  }

  /* Better source distribution styling */
  .source-info-section {
    background: var(--glass-bg);
    backdrop-filter: blur(10px);
    border: 1px solid var(--glass-border);
    border-radius: var(--radius-xl);
    padding: var(--space-xl);
    margin-bottom: var(--space-xl);
    box-shadow: var(--shadow-lg);
  }

  .info-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-lg);
    padding-bottom: var(--space-md);
    border-bottom: 1px solid var(--glass-border);
  }

  .info-title {
    font-family: var(--font-primary);
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--text-primary);
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    margin: 0;
  }

  .info-title i {
    color: var(--color-primary);
  }

  .toggle-details-btn {
    background: var(--glass-bg);
    border: 1px solid var(--glass-border);
    color: var(--text-secondary);
    padding: var(--space-sm) var(--space-lg);
    border-radius: var(--radius-full);
    font-size: 0.875rem;
    cursor: pointer;
    transition: var(--transition-fast);
    display: flex;
    align-items: center;
    gap: var(--space-xs);
    font-weight: 500;
  }

  .toggle-details-btn:hover {
    background: var(--bg-hover);
    border-color: var(--color-primary);
    color: var(--color-primary);
    transform: translateY(-1px);
    box-shadow: var(--shadow-sm);
  }

  /* Summary Cards */
  .summary-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: var(--space-lg);
  }

  .summary-card {
    background: var(--bg-secondary);
    border: 1px solid var(--glass-border);
    border-radius: var(--radius-lg);
    padding: var(--space-lg);
    display: flex;
    align-items: center;
    gap: var(--space-lg);
    transition: var(--transition-fast);
  }

  .summary-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
    border-color: var(--color-primary);
  }

  .card-icon {
    width: 48px;
    height: 48px;
    border-radius: var(--radius-lg);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    color: white;
    flex-shrink: 0;
  }

  .card-icon.sql {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  }

  .card-icon.file {
    background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
  }

  .card-icon.web {
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
  }

  .card-icon.reference {
    background: linear-gradient(135deg, #9c27b0 0%, #673ab7 100%);
  }

  .card-icon.manual {
    background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
  }

  .card-content {
    flex: 1;
  }

  .card-number {
    font-family: var(--font-primary);
    font-size: 2rem;
    font-weight: 700;
    color: var(--text-primary);
    line-height: 1;
    margin-bottom: var(--space-xs);
  }

  .card-label {
    font-size: 0.875rem;
    color: var(--text-secondary);
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  /* Details Grid */
  .info-details {
    margin-top: var(--space-lg);
    padding-top: var(--space-lg);
    border-top: 1px solid var(--glass-border);
    animation: fadeIn 0.3s ease-out;
  }

  .details-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: var(--space-xl);
  }

  .details-section {
    background: var(--bg-secondary);
    border: 1px solid var(--glass-border);
    border-radius: var(--radius-lg);
    padding: var(--space-lg);
  }

  .section-title {
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: var(--space-lg);
    display: flex;
    align-items: center;
    gap: var(--space-sm);
  }

  .section-title i {
    color: var(--color-primary);
  }

  .source-list {
    display: flex;
    flex-direction: column;
    gap: var(--space-md);
  }

  /* Hierarchical Structure Styles */
  .source-type-group {
    margin-bottom: var(--space-lg);
    border: 1px solid var(--glass-border);
    border-radius: var(--radius-md);
    overflow: hidden;
  }

  .source-type-header {
    background: var(--bg-primary);
    padding: var(--space-md);
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    cursor: pointer;
    transition: var(--transition-fast);
    border-bottom: 1px solid var(--glass-border);
  }

  .source-type-header:hover {
    background: var(--bg-hover);
  }

  .source-type-title {
    font-weight: 600;
    color: var(--text-primary);
    flex: 1;
  }

  .source-type-count {
    background: var(--gradient-primary);
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: var(--radius-full);
    font-size: 0.75rem;
    font-weight: 500;
  }

  .source-type-content {
    padding: var(--space-md);
  }

  .connection-group {
    margin-bottom: var(--space-md);
    background: var(--glass-bg);
    border-radius: var(--radius-sm);
    overflow: hidden;
  }

  .connection-header {
    background: var(--bg-secondary);
    padding: var(--space-sm) var(--space-md);
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    border-bottom: 1px solid var(--glass-border);
  }

  .connection-details {
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.8rem;
    color: var(--text-secondary);
    flex: 1;
    word-break: break-all;
  }

  .table-count {
    font-size: 0.75rem;
    color: var(--text-muted);
    background: var(--glass-bg);
    padding: 0.25rem 0.5rem;
    border-radius: var(--radius-sm);
  }

  .connection-tables {
    padding: var(--space-sm);
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: var(--space-xs);
  }

  .table-item {
    display: flex;
    align-items: center;
    gap: var(--space-xs);
    padding: var(--space-xs) var(--space-sm);
    background: var(--bg-primary);
    border-radius: var(--radius-sm);
    font-size: 0.875rem;
    transition: var(--transition-fast);
  }

  .table-item:hover {
    background: var(--bg-hover);
    transform: translateX(2px);
  }

  .table-item i {
    color: var(--color-primary);
    font-size: 0.75rem;
  }

  .table-name {
    color: var(--text-primary);
    font-weight: 500;
  }

  .no-sources {
    text-align: center;
    color: var(--text-muted);
    font-style: italic;
    padding: var(--space-lg);
  }

  /* Source type indicators in query cards */
  .query-source-type {
    border: 1px solid var(--glass-border);
  }

  .query-source-type.source-sql {
    border-color: #667eea;
    background: rgba(102, 126, 234, 0.1);
  }

  .query-source-type.source-file {
    border-color: #43e97b;
    background: rgba(67, 233, 123, 0.1);
  }

  .query-source-type.source-web {
    border-color: #4facfe;
    background: rgba(79, 172, 254, 0.1);
  }

  .query-source-type.source-reference {
    border-color: #9c27b0;
    background: rgba(156, 39, 176, 0.1);
  }

  .query-source-type.source-manual {
    border-color: #fa709a;
    background: rgba(250, 112, 154, 0.1);
  }

  /* Animations */
  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }

    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Improved Source Explorer Styles */
  .queries-section.improved {
    margin-bottom: var(--space-3xl);
  }

  /* Improved Queries List with Better Spacing */
  .improved-queries-list {
    display: flex;
    flex-direction: column;
    gap: var(--space-2xl);
    /* Increased gap between items */
    margin-bottom: var(--space-6);
  }

  /* Improved Query Card */
  .improved-query-card {
    background: var(--glass-bg);
    backdrop-filter: blur(10px);
    border: 1px solid var(--glass-border);
    border-radius: var(--radius-xl);
    box-shadow: var(--shadow-md);
    overflow: hidden;
    transition: var(--transition-smooth);
    position: relative;
  }

  .improved-query-card:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow-lg), var(--shadow-glow);
    border-color: var(--color-primary);
  }

  /* Improved Query Header */
  .improved-query-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-xl);
    background: var(--bg-secondary);
    border-bottom: 1px solid var(--glass-border);
    min-height: 100px;
    /* Ensure adequate height */
  }

  .query-title-section {
    display: flex;
    align-items: center;
    gap: var(--space-lg);
    flex: 1;
    min-width: 0;
  }

  .table-icon-wrapper {
    width: 60px;
    height: 60px;
    background: var(--gradient-primary);
    color: white;
    border-radius: var(--radius-lg);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    box-shadow: var(--shadow-glow);
    flex-shrink: 0;
  }

  .query-title-content {
    flex: 1;
    min-width: 0;
  }

  .improved-query-name {
    font-family: var(--font-primary);
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--text-primary);
    margin: 0 0 var(--space-sm) 0;
    word-break: break-word;
  }

  .query-meta {
    display: flex;
    gap: var(--space-md);
    flex-wrap: wrap;
  }

  .query-type,
  .query-lines,
  .query-source-type {
    display: flex;
    align-items: center;
    gap: var(--space-xs);
    background: var(--glass-bg);
    border: 1px solid var(--glass-border);
    color: var(--text-secondary);
    padding: var(--space-xs) var(--space-sm);
    border-radius: var(--radius-full);
    font-size: 0.875rem;
    font-weight: 500;
  }

  .query-type i,
  .query-lines i,
  .query-source-type i {
    color: var(--color-primary);
  }

  .improved-query-actions {
    display: flex;
    gap: var(--space-sm);
  }

  .improved-query-actions .icon-button {
    width: 44px;
    height: 44px;
    background: var(--glass-bg);
    border: 1px solid var(--glass-border);
    border-radius: var(--radius-md);
    color: var(--text-secondary);
    cursor: pointer;
    transition: var(--transition-fast);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1rem;
  }

  .improved-query-actions .icon-button:hover {
    background: var(--bg-hover);
    border-color: var(--color-primary);
    color: var(--color-primary);
    transform: translateY(-2px);
    box-shadow: var(--shadow-sm);
  }

  /* Improved Query Content */
  .improved-query-content {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.4s ease-out, padding 0.4s ease-out;
  }

  .improved-query-card.expanded .improved-query-content {
    max-height: 2500px;
    /* Increased max height */
    padding: var(--space-xl);
  }

  /* Improved Code Container */
  .improved-code-container {
    background: var(--bg-primary);
    border-radius: var(--radius-lg);
    border: 1px solid var(--glass-border);
    overflow: hidden;
    position: relative;
  }

  .code-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-lg);
    background: var(--bg-secondary);
    border-bottom: 1px solid var(--glass-border);
  }

  .code-label {
    font-weight: 600;
    color: var(--text-primary);
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    font-size: 0.95rem;
  }

  .code-label i {
    color: var(--color-primary);
  }

  .code-actions {
    display: flex;
    gap: var(--space-sm);
  }

  .copy-button {
    background: var(--gradient-primary);
    color: white;
    border: none;
    padding: var(--space-sm) var(--space-lg);
    border-radius: var(--radius-md);
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
    transition: var(--transition-fast);
    display: flex;
    align-items: center;
    gap: var(--space-xs);
  }

  .copy-button:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
  }

  .copy-button:disabled {
    opacity: 0.7;
    cursor: not-allowed;
  }

  .code-wrapper {
    position: relative;
  }

  .code-wrapper pre {
    margin: 0;
    padding: var(--space-xl);
    /* Increased padding for better readability */
    background: var(--bg-primary);
    max-height: 500px;
    /* Increased max height */
    overflow: auto;
    font-family: 'JetBrains Mono', 'Courier New', monospace;
    font-size: 0.9rem;
    /* Slightly larger font */
    line-height: 1.6;
    /* Better line spacing */
  }

  .code-wrapper code {
    color: var(--text-primary);
  }

  /* Search highlight improvements */
  .search-highlight {
    background: var(--gradient-warning);
    color: var(--text-primary);
    padding: 0.125rem 0.25rem;
    border-radius: var(--radius-sm);
    font-weight: 600;
    box-shadow: 0 0 8px rgba(255, 193, 7, 0.3);
  }

  /* Empty state improvements */
  .empty-state {
    padding: var(--space-3xl);
    text-align: center;
    background: var(--glass-bg);
    border-radius: var(--radius-xl);
    border: 1px solid var(--glass-border);
    margin-top: var(--space-xl);
  }

  /* Responsive improvements */
  @media (max-width: 768px) {
    .summary-cards {
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: var(--space-md);
    }

    .details-grid {
      grid-template-columns: 1fr;
      gap: var(--space-lg);
    }

    .info-header {
      flex-direction: column;
      align-items: flex-start;
      gap: var(--space-md);
    }

    .toggle-details-btn {
      align-self: flex-end;
    }

    .connection-tables {
      grid-template-columns: 1fr;
    }

    .improved-query-header {
      flex-direction: column;
      align-items: flex-start;
      gap: var(--space-lg);
      min-height: auto;
      padding: var(--space-lg);
    }

    .query-title-section {
      width: 100%;
      gap: var(--space-md);
    }

    .table-icon-wrapper {
      width: 48px;
      height: 48px;
      font-size: 20px;
    }

    .improved-query-name {
      font-size: 1.25rem;
    }

    .query-meta {
      gap: var(--space-sm);
    }

    .improved-query-actions {
      align-self: flex-end;
    }

    .improved-queries-list {
      gap: var(--space-xl);
    }

    .code-wrapper pre {
      padding: var(--space-lg);
      font-size: 0.8rem;
    }

    .code-header {
      flex-direction: column;
      align-items: flex-start;
      gap: var(--space-sm);
    }

    .code-actions {
      align-self: flex-end;
    }
  }

  /* Animation for card expansion */
  @keyframes cardExpand {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }

    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .improved-query-card.expanded .improved-query-content {
    animation: cardExpand 0.3s ease-out;
  }

  /* Better scrollbar for code blocks */
  .code-wrapper pre::-webkit-scrollbar {
    width: 8px;
    height: 8px;
  }

  .code-wrapper pre::-webkit-scrollbar-track {
    background: var(--bg-secondary);
    border-radius: var(--radius-sm);
  }

  .code-wrapper pre::-webkit-scrollbar-thumb {
    background: var(--gradient-primary);
    border-radius: var(--radius-sm);
  }

  .code-wrapper pre::-webkit-scrollbar-thumb:hover {
    background: var(--color-primary);
  }
</style>

{% endblock %}