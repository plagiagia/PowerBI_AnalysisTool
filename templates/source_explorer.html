{% extends "base.html" %} 
{% block title %}Source Explorer - Power BI Analysis Tool{% endblock %} 

{% block header_icon %}<i class="fas fa-database"></i>{% endblock %}
{% block header_title %}Source Explorer{% endblock %}
{% block header_subtitle %}Examine and analyze the M queries that form your report's data sources{% endblock %}

{% block header_stats %}
<div class="quick-stat">
  <span class="stat-number">{{ m_queries_info|length if m_queries_info else 0 }}</span>
  <span class="stat-label">Data Sources</span>
</div>
<div class="quick-stat">
  <span class="stat-number">{{ (m_queries_info|map(attribute='m_query')|map('length')|sum / 1000)|round|int if m_queries_info else 0 }}</span>
  <span class="stat-label">Total Lines (K)</span>
</div>
{% endblock %}

{% block head %}
<!-- Include Prism.js CSS for syntax highlighting -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.25.0/themes/prism.min.css" />
{% endblock %} 

{% block breadcrumbs %}
<li>
  <a href="/source-explorer"><i class="fas fa-database"></i><span class="breadcrumb-text">Source Explorer</span></a>
</li>
{% endblock %} 

{% block content %}
<!-- Page Header -->
<div class="page-header">
  <h1 class="page-title"><i class="fas fa-database"></i> Source Explorer</h1>
  <p class="page-description">
    Examine the M queries that form your report's data sources.
  </p>
</div>

<!-- Control Panel -->
<div class="control-panel">
  <!-- Search Bar -->
  <div class="search-container">
    <div class="search-input-wrapper">
      <i class="fas fa-search"></i>
      <input
        type="text"
        id="searchQueries"
        placeholder="Search in queries..."
        aria-label="Search in M queries"
      />
      <button id="clearSearch" class="clear-search" style="display: none" aria-label="Clear search">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="search-count" aria-live="polite"></div>
  </div>
</div>

<!-- Queries Section -->
<div id="queriesContainer" class="queries-section improved">
  <div class="table-toolbar">
    <div class="table-info">
      <div class="results-count">
        <span id="resultCount">{{ m_queries_info|length }}</span> queries found
      </div>
    </div>
    <div class="table-actions">
      <button id="exportQueries" class="action-button outline">
        <i class="fas fa-download"></i> Export Queries
      </button>
      <div class="view-toggle">
        <button id="expandAll" class="action-button secondary">
          <i class="fas fa-expand-alt"></i> Expand All
        </button>
        <button id="collapseAll" class="action-button secondary">
          <i class="fas fa-compress-alt"></i> Collapse All
        </button>
      </div>
    </div>
  </div>

  <!-- Queries List with Improved Layout -->
  <div id="queriesList" class="improved-queries-list">
    {% for query in m_queries_info %}
    <div class="improved-query-card" data-table="{{ query.table_name }}">
      <!-- Card Header with Better Spacing -->
      <div class="improved-query-header">
        <div class="query-title-section">
          <div class="table-icon-wrapper">
            <i class="fas fa-database"></i>
          </div>
          <div class="query-title-content">
            <h3 class="improved-query-name">{{ query.table_name }}</h3>
            <div class="query-meta">
              <span class="query-type">
                <i class="fas fa-code"></i>
                M Query
              </span>
              <span class="query-lines">
                <i class="fas fa-file-lines"></i>
                {{ query.m_query.count('\n') + 1 }} lines
              </span>
            </div>
          </div>
        </div>
        <div class="improved-query-actions">
          <button class="icon-button copy-name" title="Copy table name" data-copy="{{ query.table_name }}">
            <i class="fas fa-tag"></i>
          </button>
          <button class="icon-button toggle-expand" title="Toggle view">
            <i class="fas fa-chevron-down"></i>
          </button>
        </div>
      </div>

      <!-- Expanded Content with Better Layout -->
      <div class="improved-query-content">
        <div class="improved-code-container">
          <div class="code-header">
            <span class="code-label">
              <i class="fas fa-code"></i>
              M Query Definition
            </span>
            <div class="code-actions">
              <button class="copy-button" onclick="copyToClipboard(this)">
                <i class="fas fa-copy"></i> Copy
              </button>
            </div>
          </div>
          <div class="code-wrapper">
            <pre><code class="language-powerquery">{{ query.m_query }}</code></pre>
          </div>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>

  <!-- Empty State -->
  <div id="emptyState" class="empty-state" style="display: none">
    <div class="empty-state-icon">
      <i class="fas fa-search"></i>
    </div>
    <h3 class="empty-state-title">No matching queries found</h3>
    <p class="empty-state-message">Try adjusting your search.</p>
    <button id="clearEmptyState" class="action-button primary">
      <i class="fas fa-undo"></i> Clear Search
    </button>
  </div>
</div>

{% endblock %}

{% block scripts %}
<!-- Include Prism.js for syntax highlighting -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.25.0/prism.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.25.0/components/prism-powerquery.min.js"></script>

<script>
  document.addEventListener("DOMContentLoaded", function() {
    // DOM Elements
    const searchQueries = document.getElementById("searchQueries");
    const clearSearch = document.getElementById("clearSearch");
    const resultCount = document.getElementById("resultCount");
    const queriesList = document.getElementById("queriesList");
    const queryCards = document.querySelectorAll(".improved-query-card");
    const emptyState = document.getElementById("emptyState");
    const clearEmptyStateBtn = document.getElementById("clearEmptyState");
    const expandAllBtn = document.getElementById("expandAll");
    const collapseAllBtn = document.getElementById("collapseAll");
    const exportQueriesBtn = document.getElementById("exportQueries");
    const searchCount = document.querySelector(".search-count");
    
    // Variables for state
    let currentVisibleItems = queryCards.length;
    
    // Set up event listeners
    setupEventListeners();
    
    /**
     * Set up event listeners for interactive elements
     */
    function setupEventListeners() {
      // Search box
      if (searchQueries) {
        searchQueries.addEventListener("input", function() {
          if (clearSearch) {
            clearSearch.style.display = this.value ? "block" : "none";
          }
          performSearch();
        });
      }
      
      // Clear search button
      if (clearSearch) {
        clearSearch.addEventListener("click", function() {
          if (searchQueries) {
            searchQueries.value = "";
            clearSearch.style.display = "none";
            performSearch();
            searchQueries.focus();
          }
        });
      }
      
      // Clear empty state button
      if (clearEmptyStateBtn) {
        clearEmptyStateBtn.addEventListener("click", function() {
          if (searchQueries) {
            searchQueries.value = "";
            if (clearSearch) clearSearch.style.display = "none";
            performSearch();
            searchQueries.focus();
          }
        });
      }
      
      // Expand all button
      if (expandAllBtn) {
        expandAllBtn.addEventListener("click", function() {
          queryCards.forEach(card => {
            const button = card.querySelector(".toggle-expand");
            if (!card.classList.contains("expanded")) {
              toggleQueryCard(card, button);
            }
          });
        });
      }
      
      // Collapse all button
      if (collapseAllBtn) {
        collapseAllBtn.addEventListener("click", function() {
          queryCards.forEach(card => {
            const button = card.querySelector(".toggle-expand");
            if (card.classList.contains("expanded")) {
              toggleQueryCard(card, button);
            }
          });
        });
      }
      
      // Export queries button
      if (exportQueriesBtn) {
        exportQueriesBtn.addEventListener("click", exportAllQueries);
      }
      
      // Toggle expand buttons for each query
      document.querySelectorAll(".toggle-expand").forEach(button => {
        button.addEventListener("click", function() {
          const card = this.closest(".improved-query-card");
          toggleQueryCard(card, this);
        });
      });
      
      // Copy table name buttons
      document.querySelectorAll(".copy-name").forEach(button => {
        button.addEventListener("click", function() {
          const tableName = this.getAttribute("data-copy");
          copyToClipboardWithAnimation(this, tableName);
        });
      });
    }
    
    /**
     * Toggle expansion state of a query card
     * @param {HTMLElement} card - The query card element
     * @param {HTMLElement} button - The toggle button element
     */
    function toggleQueryCard(card, button) {
      if (!card || !button) return;
      
      const isExpanded = card.classList.toggle("expanded");
      
      // Update button icon
      button.innerHTML = isExpanded ? 
        '<i class="fas fa-chevron-up"></i>' : 
        '<i class="fas fa-chevron-down"></i>';
      
      button.setAttribute("title", isExpanded ? "Collapse" : "Expand");
    }
    
    /**
     * Search queries based on input
     */
    function performSearch() {
      const searchValue = searchQueries.value.toLowerCase();
      
      let visibleItems = 0;
      
      // Remove previous search highlights
      document.querySelectorAll(".search-highlight").forEach(el => {
        const text = el.textContent;
        const parent = el.parentNode;
        const textNode = document.createTextNode(text);
        parent.replaceChild(textNode, el);
        parent.normalize();
      });
      
      // Filter query cards
      queryCards.forEach(card => {
        const tableName = card.getAttribute("data-table");
        const queryText = card.querySelector("code").textContent.toLowerCase();
        
        let matches = true;
        if (searchValue) {
          matches = tableName.toLowerCase().includes(searchValue) || 
                   queryText.includes(searchValue);
          
          // Highlight matches in table name
          if (tableName.toLowerCase().includes(searchValue)) {
            highlightSearchTerm(card.querySelector(".improved-query-name"), searchValue);
          }
        }
        
        card.style.display = matches ? "" : "none";
        
        if (matches) visibleItems++;
      });
      
      // Update count and empty state
      currentVisibleItems = visibleItems;
      updateResultCount();
      updateEmptyState();
      
      // Update search count display
      if (searchCount && searchValue) {
        searchCount.textContent = `${visibleItems} matches`;
      } else if (searchCount) {
        searchCount.textContent = "";
      }
    }
    
    /**
     * Highlight search term in an element
     * @param {HTMLElement} element - Element containing text
     * @param {string} term - Term to highlight
     */
    function highlightSearchTerm(element, term) {
      if (!element) return;
      
      const text = element.textContent;
      
      // Create highlighted version
      const regex = new RegExp(`(${escapeRegExp(term)})`, "gi");
      const highlightedText = text.replace(regex, '<span class="search-highlight">$1</span>');
      
      // Update element content
      element.innerHTML = highlightedText;
    }
    
    /**
     * Update the result count display
     */
    function updateResultCount() {
      if (resultCount) {
        resultCount.textContent = currentVisibleItems;
      }
    }
    
    /**
     * Update empty state visibility
     */
    function updateEmptyState() {
      if (emptyState) {
        emptyState.style.display = currentVisibleItems === 0 ? "flex" : "none";
      }
      
      if (queriesList) {
        queriesList.style.display = currentVisibleItems === 0 ? "none" : "";
      }
    }
    
    /**
     * Export all visible queries to a file
     */
    function exportAllQueries() {
      const visibleCards = Array.from(queryCards).filter(
        card => card.style.display !== "none"
      );
      
      if (visibleCards.length === 0) return;
      
      const content = visibleCards.map(card => {
        const tableName = card.getAttribute("data-table");
        const query = card.querySelector("code").textContent;
        return `-- Table: ${tableName}\r\n${query}\r\n\r\n`;
      }).join('');
      
      // Create and download file
      const blob = new Blob([content], { type: "text/plain;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.setAttribute("href", url);
      link.setAttribute("download", "m_queries.txt");
      link.style.display = "none";
      document.body.appendChild(link);
      
      link.click();
      
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
      
      // Show notification if available
      if (window.PowerBIExplorer && window.PowerBIExplorer.showNotification) {
        window.PowerBIExplorer.showNotification(
          "M queries exported successfully", 
          "success"
        );
      }
    }
    
    /**
     * Copy text to clipboard with animation
     * @param {HTMLElement} button - The button that was clicked
     * @param {string} text - The text to copy
     */
    function copyToClipboardWithAnimation(button, text) {
      if (!button) return;
      
      // Store original button HTML
      const originalHTML = button.innerHTML;
      
      // Show loading spinner
      button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
      
      // Try to use Clipboard API
      if (navigator.clipboard) {
        navigator.clipboard.writeText(text)
          .then(() => {
            button.innerHTML = '<i class="fas fa-check"></i>';
            setTimeout(() => {
              button.innerHTML = originalHTML;
            }, 2000);
          })
          .catch(() => {
            fallbackCopy(text, button, originalHTML);
          });
      } else {
        fallbackCopy(text, button, originalHTML);
      }
    }
    
    /**
     * Fallback copy method for browsers without clipboard API
     * @param {string} text - Text to copy
     * @param {HTMLElement} button - Button element
     * @param {string} originalHTML - Original button HTML
     */
    function fallbackCopy(text, button, originalHTML) {
      try {
        const textArea = document.createElement("textarea");
        textArea.value = text;
        textArea.style.position = "fixed";
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        
        if (document.execCommand("copy")) {
          button.innerHTML = '<i class="fas fa-check"></i>';
        } else {
          button.innerHTML = '<i class="fas fa-times"></i>';
        }
        
        document.body.removeChild(textArea);
      } catch (err) {
        button.innerHTML = '<i class="fas fa-times"></i>';
      }
      
      setTimeout(() => {
        button.innerHTML = originalHTML;
      }, 2000);
    }
    
    /**
     * Escape special characters in string for regex
     * @param {string} string - String to escape
     * @returns {string} Escaped string
     */
    function escapeRegExp(string) {
      return string.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
    }
    
    /**
     * Function to copy code to clipboard
     * @param {HTMLElement} button - The copy button element
     */
    window.copyToClipboard = function(button) {
      const codeElement = button.closest(".improved-code-container").querySelector("code");
      copyToClipboardWithAnimation(button, codeElement.textContent);
    };
  });
</script>

<style>
/* Improved Source Explorer Styles */
.queries-section.improved {
  margin-bottom: var(--space-3xl);
}

/* Improved Queries List with Better Spacing */
.improved-queries-list {
  display: flex;
  flex-direction: column;
  gap: var(--space-2xl); /* Increased gap between items */
  margin-bottom: var(--space-6);
}

/* Improved Query Card */
.improved-query-card {
  background: var(--glass-bg);
  backdrop-filter: blur(10px);
  border: 1px solid var(--glass-border);
  border-radius: var(--radius-xl);
  box-shadow: var(--shadow-md);
  overflow: hidden;
  transition: var(--transition-smooth);
  position: relative;
}

.improved-query-card:hover {
  transform: translateY(-4px);
  box-shadow: var(--shadow-lg), var(--shadow-glow);
  border-color: var(--color-primary);
}

/* Improved Query Header */
.improved-query-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: var(--space-xl);
  background: var(--bg-secondary);
  border-bottom: 1px solid var(--glass-border);
  min-height: 100px; /* Ensure adequate height */
}

.query-title-section {
  display: flex;
  align-items: center;
  gap: var(--space-lg);
  flex: 1;
  min-width: 0;
}

.table-icon-wrapper {
  width: 60px;
  height: 60px;
  background: var(--gradient-primary);
  color: white;
  border-radius: var(--radius-lg);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 24px;
  box-shadow: var(--shadow-glow);
  flex-shrink: 0;
}

.query-title-content {
  flex: 1;
  min-width: 0;
}

.improved-query-name {
  font-family: var(--font-primary);
  font-size: 1.5rem;
  font-weight: 600;
  color: var(--text-primary);
  margin: 0 0 var(--space-sm) 0;
  word-break: break-word;
}

.query-meta {
  display: flex;
  gap: var(--space-lg);
  flex-wrap: wrap;
}

.query-type,
.query-lines {
  display: flex;
  align-items: center;
  gap: var(--space-xs);
  background: var(--glass-bg);
  border: 1px solid var(--glass-border);
  color: var(--text-secondary);
  padding: var(--space-xs) var(--space-sm);
  border-radius: var(--radius-full);
  font-size: 0.875rem;
  font-weight: 500;
}

.query-type i,
.query-lines i {
  color: var(--color-primary);
}

.improved-query-actions {
  display: flex;
  gap: var(--space-sm);
}

.improved-query-actions .icon-button {
  width: 44px;
  height: 44px;
  background: var(--glass-bg);
  border: 1px solid var(--glass-border);
  border-radius: var(--radius-md);
  color: var(--text-secondary);
  cursor: pointer;
  transition: var(--transition-fast);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1rem;
}

.improved-query-actions .icon-button:hover {
  background: var(--bg-hover);
  border-color: var(--color-primary);
  color: var(--color-primary);
  transform: translateY(-2px);
  box-shadow: var(--shadow-sm);
}

/* Improved Query Content */
.improved-query-content {
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.4s ease-out, padding 0.4s ease-out;
}

.improved-query-card.expanded .improved-query-content {
  max-height: 2500px; /* Increased max height */
  padding: var(--space-xl);
}

/* Improved Code Container */
.improved-code-container {
  background: var(--bg-primary);
  border-radius: var(--radius-lg);
  border: 1px solid var(--glass-border);
  overflow: hidden;
  position: relative;
}

.code-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: var(--space-lg);
  background: var(--bg-secondary);
  border-bottom: 1px solid var(--glass-border);
}

.code-label {
  font-weight: 600;
  color: var(--text-primary);
  display: flex;
  align-items: center;
  gap: var(--space-sm);
  font-size: 0.95rem;
}

.code-label i {
  color: var(--color-primary);
}

.code-actions {
  display: flex;
  gap: var(--space-sm);
}

.copy-button {
  background: var(--gradient-primary);
  color: white;
  border: none;
  padding: var(--space-sm) var(--space-lg);
  border-radius: var(--radius-md);
  font-size: 0.875rem;
  font-weight: 500;
  cursor: pointer;
  transition: var(--transition-fast);
  display: flex;
  align-items: center;
  gap: var(--space-xs);
}

.copy-button:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-md);
}

.code-wrapper {
  position: relative;
}

.code-wrapper pre {
  margin: 0;
  padding: var(--space-xl); /* Increased padding for better readability */
  background: var(--bg-primary);
  max-height: 500px; /* Increased max height */
  overflow: auto;
  font-family: 'JetBrains Mono', 'Courier New', monospace;
  font-size: 0.9rem; /* Slightly larger font */
  line-height: 1.6; /* Better line spacing */
}

.code-wrapper code {
  color: var(--text-primary);
}

/* Search highlight improvements */
.search-highlight {
  background: var(--gradient-warning);
  color: var(--text-primary);
  padding: 0.125rem 0.25rem;
  border-radius: var(--radius-sm);
  font-weight: 600;
  box-shadow: 0 0 8px rgba(255, 193, 7, 0.3);
}

/* Empty state improvements */
.empty-state {
  padding: var(--space-3xl);
  text-align: center;
  background: var(--glass-bg);
  border-radius: var(--radius-xl);
  border: 1px solid var(--glass-border);
  margin-top: var(--space-xl);
}

/* Responsive improvements */
@media (max-width: 768px) {
  .improved-query-header {
    flex-direction: column;
    align-items: flex-start;
    gap: var(--space-lg);
    min-height: auto;
    padding: var(--space-lg);
  }
  
  .query-title-section {
    width: 100%;
    gap: var(--space-md);
  }
  
  .table-icon-wrapper {
    width: 48px;
    height: 48px;
    font-size: 20px;
  }
  
  .improved-query-name {
    font-size: 1.25rem;
  }
  
  .query-meta {
    gap: var(--space-sm);
  }
  
  .improved-query-actions {
    align-self: flex-end;
  }
  
  .improved-queries-list {
    gap: var(--space-xl);
  }
  
  .code-wrapper pre {
    padding: var(--space-lg);
    font-size: 0.8rem;
  }
  
  .code-header {
    flex-direction: column;
    align-items: flex-start;
    gap: var(--space-sm);
  }
  
  .code-actions {
    align-self: flex-end;
  }
}

/* Animation for card expansion */
@keyframes cardExpand {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.improved-query-card.expanded .improved-query-content {
  animation: cardExpand 0.3s ease-out;
}

/* Better scrollbar for code blocks */
.code-wrapper pre::-webkit-scrollbar {
  width: 8px;
  height: 8px;
}

.code-wrapper pre::-webkit-scrollbar-track {
  background: var(--bg-secondary);
  border-radius: var(--radius-sm);
}

.code-wrapper pre::-webkit-scrollbar-thumb {
  background: var(--gradient-primary);
  border-radius: var(--radius-sm);
}

.code-wrapper pre::-webkit-scrollbar-thumb:hover {
  background: var(--color-primary);
}
</style>
{% endblock %}