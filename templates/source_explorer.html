<<<<<<< Updated upstream
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Power BI Explorer - Source Explorer</title>
    <!-- Font Awesome -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/js/all.min.js"></script>
    <!-- Prism CSS and JS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/themes/prism-tomorrow.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.24.1/components/prism-powerquery.min.js"></script>
    <style>
        :root {
            --primary-color: #2563eb;
            --accent-color: #10b981;
            --dark-bg: #1e293b;
            --light-text: #f8fafc;
            --card-bg: rgba(255, 255, 255, 0.15);
            --gradient: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.1);
            --spacing-sm: 0.5rem;
            --spacing-md: 1rem;
            --spacing-lg: 1.5rem;
            --spacing-xl: 2rem;
            --spacing-2xl: 3rem;
            --border-radius-md: 8px;
            --border-radius-lg: 16px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--dark-bg);
            color: var(--light-text);
            min-height: 100vh;
            line-height: 1.6;
        }

        .navbar {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            padding: var(--spacing-md) 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .nav-content {
            max-width: 1800px;
            margin: 0 auto;
            padding: 0 var(--spacing-xl);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .nav-logo {
            font-size: 1.5rem;
            font-weight: 700;
            background: var(--gradient);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .nav-links {
            display: flex;
            gap: var(--spacing-md);
        }

        .nav-link {
            color: var(--light-text);
            text-decoration: none;
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--border-radius-md);
            transition: background-color 0.2s ease;
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .nav-link:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .nav-link.active {
            background: var(--primary-color);
        }

        .container {
            max-width: 95%;
            margin: 80px auto 0;
            padding: 0 var(--spacing-md);
        }

        .page-header {
            text-align: center;
            margin: var(--spacing-xl) 0;
        }

        .page-header h1 {
            font-size: 2.5rem;
            font-weight: 800;
            background: var(--gradient);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            margin-bottom: var(--spacing-md);
        }

        .page-header p {
            color: var(--light-text);
            opacity: 0.8;
        }

        .source-queries {
            display: grid;
            gap: var(--spacing-xl);
            padding: var(--spacing-md);
        }

        .query-card {
            background: var(--card-bg);
            border-radius: var(--border-radius-lg);
            border: 1px solid rgba(255, 255, 255, 0.1);
            overflow: hidden;
            scroll-margin-top: 100px;
        }

        .query-card.highlighted {
            border: 2px solid var(--primary-color);
            box-shadow: 0 0 15px rgba(37, 99, 235, 0.3);
        }

        .query-header {
            padding: var(--spacing-md);
            background: rgba(37, 99, 235, 0.2);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .query-content {
            position: relative;
            background: rgba(0, 0, 0, 0.2);
        }

        pre[class*="language-"] {
            white-space: pre-wrap !important;
            word-wrap: break-word !important;
            padding: var(--spacing-lg) !important;
            max-height: 500px;
            overflow-y: auto;
        }

        code[class*="language-"] {
            white-space: pre-wrap !important;
            word-break: break-word !important;
        }

        .copy-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: var(--light-text);
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--border-radius-md);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            transition: all 0.2s ease;
        }

        .copy-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .similar-queries {
            margin-top: var(--spacing-md);
            padding: var(--spacing-md);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(0, 0, 0, 0.2);
        }

        .similar-queries-content {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-sm);
        }

        .similarity-badge {
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-sm);
            background: var(--gradient);
            padding: 0.25rem 0.75rem;
            border-radius: var(--border-radius-md);
            font-size: 0.875rem;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .gpt-analysis {
            background: rgba(0, 0, 0, 0.2);
            border-radius: var(--border-radius-md);
            margin: var(--spacing-md);
            padding: var(--spacing-md);
            display: none;
        }

        .gpt-analysis h3 {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-md);
            color: var(--accent-color);
        }

        .gpt-section {
            margin-bottom: var(--spacing-md);
            padding: var(--spacing-md);
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--border-radius-md);
        }

        .gpt-section h4 {
            color: var(--primary-color);
            margin-bottom: var(--spacing-sm);
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: var(--accent-color);
            animation: spin 1s linear infinite;
            margin-right: var(--spacing-sm);
        }

        @keyframes spin {
            to {transform: rotate(360deg);}
        }

        .gpt-btn {
            background: linear-gradient(135deg, #10a37f, #0a8d6d);
            border: none;
            color: var(--light-text);
            padding: 0.5rem 1rem;
            border-radius: var(--border-radius-md);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            font-size: 0.875rem;
            transition: transform 0.2s ease;
        }

        .gpt-btn:hover {
            transform: translateY(-1px);
        }

        .gpt-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        .similarity-badge:hover {
            transform: translateY(-1px);
        }

        .query-indicators {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }

        .folding-badge {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: 0.25rem 0.75rem;
            border-radius: var(--border-radius-md);
            font-size: 0.875rem;
        }

        .folding-badge.success {
            background: var(--accent-color);
        }

        .folding-badge.warning {
            background: #f59e0b;
        }

        .optimization-score {
            position: relative;
            width: 40px;
            height: 40px;
        }

        .score-circle {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.875rem;
            background: conic-gradient(
                var(--accent-color) calc(var(--score) * 1%),
                rgba(255, 255, 255, 0.1) calc(var(--score) * 1%)
            );
        }

        .analyze-btn {
            background: var(--gradient);
            border: none;
            color: var(--light-text);
            padding: 0.5rem 1rem;
            border-radius: var(--border-radius-md);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            font-size: 0.875rem;
            transition: transform 0.2s ease;
        }

        .analyze-btn:hover {
            transform: translateY(-1px);
        }

        .analysis-panel {
            background: rgba(0, 0, 0, 0.2);
            border-radius: var(--border-radius-md);
            margin: var(--spacing-md);
            padding: var(--spacing-md);
        }

        .issues-list {
            display: grid;
            gap: var(--spacing-md);
            margin-top: var(--spacing-md);
        }

        .issue-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--border-radius-md);
            padding: var(--spacing-md);
            border-left: 4px solid;
        }

        .issue-item.high { border-color: #ef4444; }
        .issue-item.medium { border-color: #f59e0b; }
        .issue-item.low { border-color: #3b82f6; }

        .issue-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-sm);
        }

        .impact-badge {
            padding: 0.25rem 0.5rem;
            border-radius: var(--border-radius-sm);
            font-size: 0.75rem;
            font-weight: bold;
        }

        .impact-badge.high { background: #ef4444; }
        .impact-badge.medium { background: #f59e0b; }
        .impact-badge.low { background: #3b82f6; }

        .issue-recommendation {
            margin: var(--spacing-sm) 0;
            opacity: 0.8;
        }

        .issue-location {
            font-size: 0.875rem;
            opacity: 0.6;
        }

        .toast {
            position: fixed;
            bottom: var(--spacing-xl);
            right: var(--spacing-xl);
            background: var(--gradient);
            color: var(--light-text);
            padding: var(--spacing-md) var(--spacing-lg);
            border-radius: var(--border-radius-md);
            box-shadow: var(--shadow-lg);
            transform: translateY(100%);
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        @media (max-width: 1200px) {
            .container {
                max-width: 98%;
                padding: 0 var(--spacing-sm);
            }
        }

        @media (max-width: 768px) {
            .nav-links {
                display: none;
            }
            
            .page-header h1 {
                font-size: 2rem;
            }

            .query-indicators {
                flex-direction: column;
                align-items: flex-start;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-content">
            <div class="nav-logo">Power BI Explorer</div>
            <div class="nav-links">
                <a href="{{ url_for('index') }}" class="nav-link">Home</a>
                <a href="{{ url_for('table_view') }}" class="nav-link">Visual Fields</a>
                <a href="{{ url_for('lineage_view') }}" class="nav-link">Data Lineage</a>
                <a href="{{ url_for('dax_expressions') }}" class="nav-link">DAX Explorer</a>
                <a href="{{ url_for('m_queries') }}" class="nav-link active">Source Explorer</a>
                <a href="{{ url_for('unused_measures_view') }}" class="nav-link">Unused Measures</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="page-header">
            <h1>Source Explorer</h1>
            <p>Browse and analyze your Power BI data sources</p>
        </div>

        <div class="source-queries">
            {% for query_info in m_queries_info %}
            <div id="query-{{ query_info.table_name|replace(' ', '-') }}" class="query-card">
                <div class="query-header">
                    <span>{{ query_info.table_name }}</span>
                    <div class="query-indicators">

                        <button class="gpt-btn" onclick="analyzeWithGPT(this)" data-table="{{ query_info.table_name }}">
                            <i class="fas fa-brain"></i>
                            GPT Analysis
                        </button>
                        
                        {% if query_info.folding_analysis.is_sql %}
                            {% if query_info.folding_analysis.can_fold %}
                            <span class="folding-badge success">
                                <i class="fas fa-check-circle"></i>
                                Query Folding Enabled
                            </span>
                            {% else %}
                            <span class="folding-badge warning">
                                <i class="fas fa-exclamation-triangle"></i>
                                Query Folding Limited
                            </span>
                            {% endif %}
                            <div class="optimization-score">
                                <div class="score-circle" style="--score: {{ query_info.folding_analysis.optimization_score }}">
                                    {{ query_info.folding_analysis.optimization_score }}
                                </div>
                            </div>
                            <button class="analyze-btn" onclick="toggleAnalysis(this)">
                                <i class="fas fa-microscope"></i>
                                Analyze
                            </button>
                        {% endif %}
                        <button class="copy-btn" onclick="copyCode(this)" data-table="{{ query_info.table_name }}">
                            <i class="fas fa-copy"></i>
                            Copy
                        </button>
                    </div>
                </div>

                {% if query_info.folding_analysis.is_sql %}
                <div class="analysis-panel" style="display: none;">
                    <h3>Query Folding Analysis</h3>
                    {% if query_info.folding_analysis.issues %}
                    <div class="issues-list">
                        {% for issue in query_info.folding_analysis.issues %}
                        <div class="issue-item {{ issue.impact }}">
                            <div class="issue-header">
                                <span class="issue-type">{{ issue.pattern|replace('_', ' ')|title }}</span>
                                <span class="impact-badge {{ issue.impact }}">
                                    {{ issue.impact|upper }} IMPACT
                                </span>
                            </div>
                            <p class="issue-recommendation">{{ issue.recommendation }}</p>
                            <div class="issue-location">
                                Lines: {{ issue.line_numbers|join(', ') }}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="no-issues">
                        <i class="fas fa-check-circle"></i>
                        No query folding issues detected!
                    </div>
                    {% endif %}
                </div>

                <div class="gpt-analysis">
                    <h3>
                        <i class="fas fa-brain"></i>
                        GPT Analysis
                    </h3>
                    <div class="gpt-content"></div>
                </div>
                
                {% endif %}
                                    <div class="query-content">
                                        <pre><code class="language-powerquery">{{ query_info.m_query }}</code></pre>
                                    </div>

                                    {% if query_info.similar_queries %}
                                    <div class="similar-queries">
                                        <div class="similar-queries-content">
                                            {% for similar in query_info.similar_queries %}
                                            <div class="similarity-badge" onclick="highlightQuery('{{ similar.table_name }}')">
                                                <i class="fas fa-link"></i>
                                                {{ similar.table_name }}
                                                <span>({{ similar.similarity }}% similar)</span>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                                {% endfor %}
                            </div>
                        </div>

                        <div class="toast" id="toast">
                            <i class="fas fa-check"></i>
                            <span>Code copied to clipboard!</span>
                        </div>

                        <script>
                            // Code highlighting
                            document.addEventListener('DOMContentLoaded', () => {
                                Prism.highlightAll();
                            });

                            // Copy functionality
                            function copyCode(button) {
                                const tableName = button.getAttribute('data-table');
                                const codeBlock = button.closest('.query-card').querySelector('code');
                                const textArea = document.createElement('textarea');
                                textArea.value = codeBlock.textContent;
                                document.body.appendChild(textArea);
                                textArea.select();
                                document.execCommand('copy');
                                document.body.removeChild(textArea);
                                showToast();

                                // Update button text temporarily
                                const originalContent = button.innerHTML;
                                button.innerHTML = '<i class="fas fa-check"></i> Copied!';
                                setTimeout(() => {
                                    button.innerHTML = originalContent;
                                }, 2000);
                            }

                            // Toast notification
                            function showToast() {
                                const toast = document.getElementById('toast');
                                toast.classList.add('show');
                                setTimeout(() => {
                                    toast.classList.remove('show');
                                }, 3000);
                            }

                            // Query highlighting
                            function highlightQuery(tableName) {
                                // Remove previous highlights
                                document.querySelectorAll('.query-card').forEach(card => {
                                    card.classList.remove('highlighted');
                                });

                                // Add highlight to target query
                                const queryId = `query-${tableName.replace(/ /g, '-')}`;
                                const targetQuery = document.getElementById(queryId);
                                if (targetQuery) {
                                    targetQuery.classList.add('highlighted');
                                    targetQuery.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                }
                            }

                            // Analysis panel toggle
                            function toggleAnalysis(button) {
                                const panel = button.closest('.query-card').querySelector('.analysis-panel');
                                const isHidden = panel.style.display === 'none';

                                // Close all other panels first
                                document.querySelectorAll('.analysis-panel').forEach(p => {
                                    p.style.display = 'none';
                                });
                                document.querySelectorAll('.analyze-btn').forEach(btn => {
                                    btn.innerHTML = '<i class="fas fa-microscope"></i> Analyze';
                                });

                                // Toggle current panel
                                panel.style.display = isHidden ? 'block' : 'none';
                                button.innerHTML = isHidden ? 
                                    '<i class="fas fa-times"></i> Close' : 
                                    '<i class="fas fa-microscope"></i> Analyze';
                            }

                            // Clear highlight when clicking elsewhere
                            document.addEventListener('click', function(event) {
                                if (!event.target.closest('.similarity-badge')) {
                                    document.querySelectorAll('.query-card').forEach(card => {
                                        card.classList.remove('highlighted');
                                    });
                                }
                            });


                            async function analyzeWithGPT(button) {
                                const card = button.closest('.query-card');
                                const query = card.querySelector('code').textContent;
                                const tableName = button.getAttribute('data-table');
                                const gptPanel = card.querySelector('.gpt-analysis');
                                const gptContent = gptPanel.querySelector('.gpt-content');

                                // Disable button and show loading state
                                button.disabled = true;
                                const originalContent = button.innerHTML;
                                button.innerHTML = '<div class="loading-spinner"></div>Analyzing...';

                                try {
                                    const response = await fetch('/analyze-query', {
                                        method: 'POST',
                                        headers: {
                                            'Content-Type': 'application/json',
                                        },
                                        body: JSON.stringify({
                                            query: query,
                                            table_name: tableName
                                        })
                                    });

                                    const data = await response.json();

                                    if (data.success) {
                                        // Parse the analysis and format it into sections
                                        const formattedAnalysis = formatGPTAnalysis(data.analysis);
                                        gptContent.innerHTML = formattedAnalysis;
                                        gptPanel.style.display = 'block';
                                    } else {
                                        gptContent.innerHTML = `<div class="error">Analysis failed: ${data.error}</div>`;
                                        gptPanel.style.display = 'block';
                                    }
                                } catch (error) {
                                    gptContent.innerHTML = `<div class="error">Error: ${error.message}</div>`;
                                    gptPanel.style.display = 'block';
                                } finally {
                                    // Restore button state
                                    button.disabled = false;
                                    button.innerHTML = originalContent;
                                }
                            }

                            function formatGPTAnalysis(analysis) {
                                // Split the analysis into sections based on numbering or headers
                                const sections = analysis.split(/\d+\./g).filter(Boolean);

                                return sections.map(section => {
                                    const [title, ...content] = section.trim().split('\n');
                                    return `
                                        <div class="gpt-section">
                                            <h4>${title.trim()}</h4>
                                            <div>${content.join('\n')}</div>
                                        </div>
                                    `;
                                }).join('');
                            }
                            
                        </script>
                    </body>
                    </html>
=======
<!-- templates/source_explorer.html -->
{% extends "base.html" %} {% block title %}Source Explorer{% endblock %} {%
block head %}
<!-- Include Prism.js CSS for syntax highlighting -->
<link
  rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.25.0/themes/prism.min.css"
/>
<!-- Include FontAwesome for icons -->
<link
  rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
/>
{% endblock %} {% block content %}
<h1>Source Explorer</h1>
<p>
  Explore the M queries that form the foundation of your report's data sources.
</p>

<!-- M Queries Table -->
<div class="code-table-container">
  <table class="code-table">
    <thead>
      <tr>
        <th>Query Name</th>
        <th>M Query</th>
      </tr>
    </thead>
    <tbody>
      {% for query in m_queries_info %}
      <tr>
        <td>{{ query.table_name }}</td>
        <td>
          <div class="code-container">
            <pre><code class="language-powerquery">{{ query.m_query }}</code></pre>
            <button class="copy-button" onclick="copyToClipboard(this)">
              <i class="fas fa-copy"></i> Copy
            </button>
          </div>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% endblock %} {% block scripts %}
<!-- Include Prism.js for syntax highlighting -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.25.0/prism.min.js"></script>
<!-- Include Prism.js Power Query component -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.25.0/components/prism-powerquery.min.js"></script>
<!-- Include FontAwesome for icons -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/js/all.min.js"></script>
<!-- JavaScript function to copy M query to clipboard -->
<script>
  function copyToClipboard(button) {
    var codeElement = button.parentElement.querySelector("code");
    var textArea = document.createElement("textarea");
    textArea.value = codeElement.textContent;
    document.body.appendChild(textArea);
    textArea.select();
    document.execCommand("copy");
    document.body.removeChild(textArea);
    button.innerHTML = '<i class="fas fa-check"></i> Copied';
    setTimeout(function () {
      button.innerHTML = '<i class="fas fa-copy"></i> Copy';
    }, 2000);
  }
</script>
{% endblock %}
>>>>>>> Stashed changes
