{% extends "base.html" %}

{% block title %}AI Analysis - {{ app_name }}{% endblock %}

{% block breadcrumbs %}
<li>
  <a href="/ai-analysis"><i class="fas fa-robot"></i><span class="breadcrumb-text">AI Analysis</span></a>
</li>
{% endblock %}

{% block content %}
<div class="content-container">
  <div class="content-header">
    <h1><i class="fas fa-robot"></i> AI-Powered Analysis</h1>
    <p class="subtitle">Leverage AI to gain insights from your Power BI report</p>
  </div>

  <div class="card-grid">
    <!-- DAX Analysis Card -->
    <div class="card">
      <div class="card-header">
        <h2><i class="fas fa-code"></i> DAX Expression Analysis</h2>
      </div>
      <div class="card-content">
        <p>Get AI-powered insights and suggestions for your DAX expressions.</p>
        <form id="daxAnalysisForm" action="/ai-analysis/dax" method="post" class="ai-form">
          <div class="form-group">
            <label for="daxExpression">DAX Expression:</label>
            <textarea id="daxExpression" name="daxExpression" rows="6" placeholder="Enter your DAX expression here..." required></textarea>
          </div>
          <div class="form-actions">
            <button type="submit" class="btn primary">Analyze</button>
          </div>
        </form>
        {% if dax_analysis_result %}
        <div class="analysis-result">
          <h3>Analysis Result:</h3>
          <div class="result-content">
            {{ dax_analysis_result | safe }}
          </div>
        </div>
        {% endif %}
      </div>
    </div>

    <!-- Measure Suggestion Card -->
    <div class="card">
      <div class="card-header">
        <h2><i class="fas fa-lightbulb"></i> Measure Suggestions</h2>
      </div>
      <div class="card-content">
        <p>Get AI-powered suggestions for DAX measures based on your business question.</p>
        <form id="measureSuggestionForm" action="/ai-analysis/suggest-measures" method="post" class="ai-form">
          <div class="form-group">
            <label for="tableSchema">Table Schema:</label>
            <textarea id="tableSchema" name="tableSchema" rows="6" placeholder="Describe your table schema here..." required></textarea>
          </div>
          <div class="form-group">
            <label for="businessQuestion">Business Question:</label>
            <textarea id="businessQuestion" name="businessQuestion" rows="3" placeholder="What business question are you trying to answer?" required></textarea>
          </div>
          <div class="form-actions">
            <button type="submit" class="btn primary">Get Suggestions</button>
          </div>
        </form>
        {% if measure_suggestion_result %}
        <div class="analysis-result">
          <h3>Suggested Measures:</h3>
          <div class="result-content">
            {{ measure_suggestion_result | safe }}
          </div>
        </div>
        {% endif %}
      </div>
    </div>

    <!-- Model Relationship Analysis Card -->
    <div class="card">
      <div class="card-header">
        <h2><i class="fas fa-project-diagram"></i> Model Relationship Analysis</h2>
      </div>
      <div class="card-content">
        <p>Get AI-powered insights about your data model relationships.</p>
        <form id="modelAnalysisForm" action="/ai-analysis/model-relationships" method="post" class="ai-form">
          <div class="form-group">
            <label for="modelJson">Model JSON:</label>
            <textarea id="modelJson" name="modelJson" rows="6" placeholder="Paste your model JSON here..." required></textarea>
          </div>
          <div class="form-actions">
            <button type="submit" class="btn primary">Analyze</button>
            <button type="button" id="loadModelBtn" class="btn secondary">Load Current Model</button>
          </div>
        </form>
        {% if model_analysis_result %}
        <div class="analysis-result">
          <h3>Model Analysis:</h3>
          <div class="result-content">
            {{ model_analysis_result | safe }}
          </div>
        </div>
        {% endif %}
      </div>
    </div>

    <!-- General AI Assistant Card -->
    <div class="card">
      <div class="card-header">
        <h2><i class="fas fa-comments"></i> Power BI Assistant</h2>
      </div>
      <div class="card-content">
        <p>Ask any Power BI related question and get AI-powered answers.</p>
        <form id="assistantForm" action="/ai-analysis/assistant" method="post" class="ai-form">
          <div class="form-group">
            <label for="question">Your Question:</label>
            <textarea id="question" name="question" rows="3" placeholder="Ask a Power BI related question..." required></textarea>
          </div>
          <div class="form-actions">
            <button type="submit" class="btn primary">Ask</button>
          </div>
        </form>
        {% if assistant_result %}
        <div class="analysis-result">
          <h3>Answer:</h3>
          <div class="result-content">
            {{ assistant_result | safe }}
          </div>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Handle "Load Current Model" button click
    const loadModelBtn = document.getElementById('loadModelBtn');
    if (loadModelBtn) {
      loadModelBtn.addEventListener('click', async function() {
        try {
          const response = await fetch('/api/model-json');
          if (!response.ok) {
            throw new Error('Failed to load model data');
          }
          const data = await response.json();
          document.getElementById('modelJson').value = JSON.stringify(data, null, 2);
        } catch (error) {
          showNotification('Error loading model data: ' + error.message, 'error');
        }
      });
    }

    // Function to show notifications
    function showNotification(message, type = 'info') {
      const container = document.querySelector('.notification-container');
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.innerHTML = `
        <div class="notification-content">
          <span>${message}</span>
        </div>
        <button class="notification-close" aria-label="Close notification">
          <i class="fas fa-times"></i>
        </button>
      `;
      
      container.appendChild(notification);
      
      // Add event listener to close button
      notification.querySelector('.notification-close').addEventListener('click', function() {
        notification.classList.add('fade-out');
        setTimeout(() => {
          notification.remove();
        }, 300);
      });
      
      // Auto-remove after 5 seconds
      setTimeout(() => {
        if (notification.parentNode) {
          notification.classList.add('fade-out');
          setTimeout(() => {
            if (notification.parentNode) {
              notification.remove();
            }
          }, 300);
        }
      }, 5000);
    }
  });
</script>
{% endblock %}
